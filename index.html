<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°å­¦2å¹´ç”Ÿå‘ã‘ è‹±èªæ–‡æ³•ã‚ãã³ v12.6</title>
    
    <!-- 1. Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. React ãƒ©ã‚¤ãƒ–ãƒ©ãƒª -->
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    
    <!-- 3. Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Google Fonts & Custom Styles -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;700;800&display=swap');
        body { font-family: 'M PLUS Rounded 1c', sans-serif; user-select: none; }
        
        .bg-pattern {
            background-color: #f0f9ff;
            background-image: radial-gradient(#bae6fd 1px, transparent 1px);
            background-size: 24px 24px;
        }

        /* Animations */
        @keyframes pop-in { 0% { transform: scale(0.5); opacity: 0; } 70% { transform: scale(1.1); } 100% { transform: scale(1); opacity: 1; } }
        .animate-pop-in { animation: pop-in 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        @keyframes slide-up { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .animate-slide-up { animation: slide-up 0.5s ease-out forwards; }
        @keyframes bounce-gentle { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }
        .animate-bounce-gentle { animation: bounce-gentle 2s infinite; }
        @keyframes shake { 0% { transform: translate(1px, 1px) rotate(0deg); } 10% { transform: translate(-1px, -2px) rotate(-1deg); } 20% { transform: translate(-3px, 0px) rotate(1deg); } 30% { transform: translate(3px, 2px) rotate(0deg); } 40% { transform: translate(1px, -1px) rotate(1deg); } 50% { transform: translate(-1px, 2px) rotate(-1deg); } 60% { transform: translate(-3px, 1px) rotate(0deg); } 70% { transform: translate(3px, 1px) rotate(-1deg); } 80% { transform: translate(-1px, -1px) rotate(1deg); } 90% { transform: translate(1px, 2px) rotate(0deg); } 100% { transform: translate(1px, -2px) rotate(-1deg); } }
        .animate-shake { animation: shake 0.5s infinite; }
        @keyframes shine { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
        .bg-shine { background-size: 200% 200%; animation: shine 3s linear infinite; }

        .confetti { position: fixed; width: 12px; height: 12px; animation: fall linear forwards; z-index: 100; pointer-events: none; }
        @keyframes fall { to { transform: translateY(100vh) rotate(720deg); } }
        
        .card-glow { box-shadow: 0 0 20px rgba(255, 255, 255, 0.8), 0 0 40px rgba(255, 215, 0, 0.6); }
        .combo-text { text-shadow: 2px 2px 0px #fff, 4px 4px 0px rgba(0,0,0,0.2); }
        
        /* Ruby text adjustments */
        rt { user-select: none; font-size: 0.6em; color: #64748b; }
        
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* Star Styling */
        .star-active { filter: drop-shadow(0 0 4px rgba(234, 179, 8, 0.8)); transform: scale(1.1); }

        /* --- Card Styles --- */
        @keyframes holo { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
        .card-ssr { background: linear-gradient(135deg, #fce7f3, #e9d5ff, #c4b5fd, #a5f3fc, #fce7f3); background-size: 300% 300%; animation: holo 4s ease infinite; border: 2px solid #fff; box-shadow: 0 0 15px rgba(167, 139, 250, 0.5); }
        @keyframes cosmos { 0% { background-position: 0% 0%; } 50% { background-position: 100% 100%; } 100% { background-position: 0% 0%; } }
        .card-l { background: radial-gradient(circle at center, #4c1d95, #1e1b4b, #000000); background-size: 200% 200%; animation: cosmos 8s ease infinite; border: 2px solid #818cf8; box-shadow: 0 0 20px rgba(79, 70, 229, 0.8); color: white; }
        .card-l .emoji-display { filter: drop-shadow(0 0 10px rgba(255, 255, 255, 0.8)); }
    </style>
</head>
<body class="bg-pattern text-slate-800">

    <div id="root"></div>

    <script type="text/babel">
const { useEffect, useMemo, useRef, useState, useCallback } = React;

// --- Components ---
function F({ rb, rt }) {
  return (<ruby className="[ruby-position:over]"><span>{rb}</span><rt>{rt}</rt></ruby>);
}

const T = ({ t }) => {
    // æ¼¢å­—ã¨ãƒ•ãƒªã‚¬ãƒŠã®ãƒãƒƒãƒ”ãƒ³ã‚°
    const map = {
        "å‹‰å¼·": <F rb="å‹‰å¼·" rt="ã¹ã‚“ãã‚‡ã†" />, "è³ªå•": <F rb="è³ªå•" rt="ã—ã¤ã‚‚ã‚“" />, "æ­£è§£": <F rb="æ­£è§£" rt="ã›ã„ã‹ã„" />,
        "å•é¡Œ": <F rb="å•é¡Œ" rt="ã‚‚ã‚“ã ã„" />, "å˜èª": <F rb="å˜èª" rt="ãŸã‚“ã”" />, "ä¸¦": <F rb="ä¸¦" rt="ãªã‚‰" />,
        "æ›¿": <F rb="ã‹" />, "é¸": <F rb="é¸" rt="ãˆã‚‰" />, "å…¨å•": <F rb="å…¨å•" rt="ãœã‚“ã‚‚ã‚“" />,
        "è¨˜éŒ²": <F rb="è¨˜éŒ²" rt="ãã‚ã" />, "æœ€é«˜": <F rb="æœ€é«˜" rt="ã•ã„ã“ã†" />, "ç‚¹": <F rb="ç‚¹" rt="ã¦ã‚“" />,
        "å›": <F rb="å›" rt="ã‹ã„" />, "ä¿å­˜": <F rb="ä¿å­˜" rt="ã»ãã‚“" />, "èª­": <F rb="èª­" rt="ã‚ˆ" />, "è¾¼": <F rb="è¾¼" rt="ã“" />,
        "ä»Šæ—¥": <F rb="ä»Šæ—¥" rt="ãã‚‡ã†" />, "åˆè¨ˆ": <F rb="åˆè¨ˆ" rt="ã”ã†ã‘ã„" />, "æ˜¨å¤œ": <F rb="æ˜¨å¤œ" rt="ã•ãã‚„" />,
        "æ˜¨æ—¥": <F rb="æ˜¨æ—¥" rt="ãã®ã†" />, "ç§": <F rb="ç§" rt="ã‚ãŸã—" />, 
        "èª°": <F rb="èª°" rt="ã ã‚Œ" />, "æ˜¼": <F rb="æ˜¼" rt="ã²ã‚‹" />,
        "é£¯": <F rb="é£¯" rt="ã¯ã‚“" />, "å‹•è©": <F rb="å‹•è©" rt="ã©ã†ã—" />, "ç¾åœ¨": <F rb="ç¾åœ¨" rt="ã’ã‚“ã–ã„" />,
        "éå»": <F rb="éå»" rt="ã‹ã“" />, "åŠ©å‹•è©": <F rb="åŠ©å‹•è©" rt="ã˜ã‚‡ã©ã†ã—" />, "ç–‘å•è©": <F rb="ç–‘å•è©" rt="ãã‚‚ã‚“ã—" />,
        "ç–‘å•": <F rb="ç–‘å•" rt="ãã‚‚ã‚“" />, 
        "å‰ç½®è©": <F rb="å‰ç½®è©" rt="ãœã‚“ã¡ã—" />, "å ´æ‰€": <F rb="å ´æ‰€" rt="ã°ã—ã‚‡" />, "é›£æ˜“åº¦": <F rb="é›£æ˜“åº¦" rt="ãªã‚“ã„ã©" />,
        "ç©´åŸ‹": <F rb="ç©´åŸ‹" rt="ã‚ãªã†" />, "ä¸¦ã¹æ›¿": <F rb="ä¸¦ã¹æ›¿" rt="ãªã‚‰ã¹ã‹" />,
        "è¤‡": <F rb="è¤‡" rt="ãµã" />, "æ•°": <F rb="ã™ã†" />, "é€²è¡Œå½¢": <F rb="é€²è¡Œå½¢" rt="ã—ã‚“ã“ã†ã‘ã„" />,
        "ä»£åè©": <F rb="ä»£åè©" rt="ã ã„ã‚ã„ã—" />, "è¦å‰‡": <F rb="è¦å‰‡" rt="ããã" />, "ä¸è¦å‰‡": <F rb="ä¸è¦å‰‡" rt="ãµããã" />,
        "æ´»ç”¨": <F rb="æ´»ç”¨" rt="ã‹ã¤ã‚ˆã†" />, "è¡¨": <F rb="è¡¨" rt="ã²ã‚‡ã†" />, "ä¸»èª": <F rb="ä¸»èª" rt="ã—ã‚…ã”" />,
        "å½¢": <F rb="å½¢" rt="ã‹ãŸã¡" />, "ç¿’æ…£": <F rb="ç¿’æ…£" rt="ã—ã‚…ã†ã‹ã‚“" />, "çŠ¶æ…‹": <F rb="çŠ¶æ…‹" rt="ã˜ã‚‡ã†ãŸã„" />,
        "ä»¥å¤–": <F rb="ä»¥å¤–" rt="ã„ãŒã„" />, "ç‰¹åˆ¥": <F rb="ç‰¹åˆ¥" rt="ã¨ãã¹ã¤" />, "å¤‰": <F rb="å¤‰" rt="ã‹" />,
        "è¦š": <F rb="è¦š" rt="ãŠã¼" />, "æ„å‘³": <F rb="æ„å‘³" rt="ã„ã¿" />, "è¶³": <F rb="è¶³" rt="ãŸ" />,
        "ç½®": <F rb="ç½®" rt="ãŠ" />, "å…ƒ": <F rb="å…ƒ" rt="ã‚‚ã¨" />, "æœ€åˆ": <F rb="æœ€åˆ" rt="ã•ã„ã—ã‚‡" />,
        "è¨€è‘‰": <F rb="è¨€è‘‰" rt="ã“ã¨ã°" />, "å¦å®š": <F rb="å¦å®š" rt="ã²ã¦ã„" />, "æ§‹æ–‡": <F rb="æ§‹æ–‡" rt="ã“ã†ã¶ã‚“" />,
        "ç²å¾—": <F rb="ç²å¾—" rt="ã‹ãã¨ã" />, "å˜": <F rb="å˜" rt="ãŸã‚“" />, "ä¾‹": <F rb="ä¾‹" rt="ã‚Œã„" />,
        "åˆ¥": <F rb="åˆ¥" rt="ã¹ã¤" />, "æœº": <F rb="æœº" rt="ã¤ããˆ" />
    };
    let parts = [t];
    Object.keys(map).forEach(key => {
        const newParts = [];
        parts.forEach(part => {
            if (typeof part === 'string') {
                const split = part.split(key);
                split.forEach((s, i) => { if (s) newParts.push(s); if (i < split.length - 1) newParts.push(map[key]); });
            } else { newParts.push(part); }
        });
        parts = newParts;
    });
    return <span>{parts.map((p, i) => <React.Fragment key={i}>{p}</React.Fragment>)}</span>;
};

const speakEn = (text) => {
  try {
    if (typeof window === "undefined" || !window.speechSynthesis) return;
    window.speechSynthesis.cancel();
    const u = new SpeechSynthesisUtterance(text);
    u.lang = "en-US"; u.rate = 0.85; 
    window.speechSynthesis.speak(u);
  } catch {}
};

const getTodayString = () => {
  const d = new Date();
  return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
};

// --- Config ---
const LS_KEY = "eigoAppS2_v12_6";
const QUESTIONS_PER_SET = 10;
const MAX_STARS = 3;
const GACHA_COST = 200;

// --- Data: Hint Tables ---
const HINT_TABLES = {
    "hint_be": {
        title: "Beå‹•è©ã®ãƒ«ãƒ¼ãƒ«",
        content: (
            <div className="text-base space-y-4">
                <div className="bg-pink-50 p-3 rounded-xl border border-pink-100">
                    <h4 className="font-bold text-pink-700 mb-2 border-b border-pink-200 pb-1"><T t="ç¾åœ¨å½¢ (ä»Šã®è©±)"/></h4>
                    <ul className="space-y-2">
                        <li><span className="text-xl font-bold mr-2">am</span> : <T t="ä¸»èª"/>ãŒ <b>I</b> (ã‚ãŸã—)</li>
                        <li><span className="text-xl font-bold mr-2">is</span> : <T t="ä¸»èª"/>ãŒ <b>ã²ã¨ã‚Š</b> (He, She, This...)</li>
                        <li><span className="text-xl font-bold mr-2">are</span> : <T t="ä¸»èª"/>ãŒ <b>You</b> ã‹ <b>ãŸãã•ã‚“</b></li>
                    </ul>
                </div>
                <div className="bg-blue-50 p-3 rounded-xl border border-blue-100">
                    <h4 className="font-bold text-blue-700 mb-2 border-b border-blue-200 pb-1"><T t="éå»å½¢ (æ˜”ã®è©±)"/></h4>
                    <ul className="space-y-2">
                        <li><span className="text-xl font-bold mr-2">was</span> : am ã¨ is ã®<T t="éå»"/> (I, He, She...)</li>
                        <li><span className="text-xl font-bold mr-2">were</span> : are ã®<T t="éå»"/> (You, We, They...)</li>
                    </ul>
                </div>
            </div>
        )
    },
    "hint_verb_present": {
        title: "ä¸€èˆ¬å‹•è©ãƒ»ç¾åœ¨å½¢",
        content: (
            <div className="text-base space-y-3 bg-sky-50 p-4 rounded-xl border border-sky-100">
                <p><T t="ç¿’æ…£"/>ã‚„ã€ä»Šã®<T t="çŠ¶æ…‹"/>ã‚’ã„ã†ã¨ãã€‚</p>
                <div className="border-t border-sky-200 my-1"></div>
                <h4 className="font-bold text-sky-800 text-lg">â˜… 3<T t="å˜"/>ç¾(ã•ã‚“ãŸã‚“ã’ã‚“)ã® S</h4>
                <p><T t="ä¸»èª"/>ãŒ <b>I, You <T t="ä»¥å¤–"/>ã®ã²ã¨ã‚Š</b> (He, She, Taro, Dogãªã©) ã®ã¨ãã€<T t="å‹•è©"/>ã« <b>s</b> ã‹ <b>es</b> ã‚’ã¤ã‘ã¾ã™ã€‚</p>
                <div className="grid grid-cols-2 gap-2 mt-2 font-bold text-center text-lg">
                    <div className="bg-white rounded p-1 shadow-sm">play â†’ play<span className="text-red-500">s</span></div>
                    <div className="bg-white rounded p-1 shadow-sm">go â†’ go<span className="text-red-500">es</span></div>
                    <div className="bg-white rounded p-1 shadow-sm">watch â†’ watch<span className="text-red-500">es</span></div>
                    <div className="bg-white rounded p-1 shadow-sm">study â†’ stud<span className="text-red-500">ies</span></div>
                </div>
            </div>
        )
    },
    "hint_verb_past": {
        title: "ä¸€èˆ¬å‹•è©ãƒ»éå»å½¢",
        content: (
            <div className="text-base space-y-3 bg-orange-50 p-4 rounded-xl border border-orange-100">
                <p>çµ‚ã‚ã£ãŸã“ã¨ã€æ˜”ã®ã“ã¨ã‚’ã„ã†ã¨ãã€‚</p>
                <div className="border-t border-orange-200 my-1"></div>
                <h4 className="font-bold text-orange-800 text-lg">â˜… ed ã‚’ã¤ã‘ã‚‹</h4>
                <p>å¤šãã®<T t="å‹•è©"/>ã¯ã€å¾Œã‚ã« <b>ed</b> ã‚’ã¤ã‘ã‚‹ã ã‘ã§<T t="éå»å½¢"/>ã«ãªã‚Šã¾ã™ã€‚</p>
                <div className="mt-2 font-bold text-center bg-white rounded p-2 text-lg shadow-sm">
                    play â†’ play<span className="text-red-500">ed</span><br/>
                    watch â†’ watch<span className="text-red-500">ed</span><br/>
                    cook â†’ cook<span className="text-red-500">ed</span>
                </div>
                <p className="text-xs text-right mt-1 text-slate-500">â€»<T t="ä¸è¦å‰‡å‹•è©"/>ã¯<T t="åˆ¥"/>ã®ãƒªã‚¹ãƒˆã‚’è¦‹ã¦ã­</p>
            </div>
        )
    },
    "hint_verb_irregular": {
        title: "ä¸è¦å‰‡å‹•è©ãƒªã‚¹ãƒˆ",
        content: (
            <div className="text-base">
                <p className="mb-2"><T t="å½¢"/>ãŒ<T t="ç‰¹åˆ¥"/>ã«<T t="å¤‰"/>ã‚ã‚‹<T t="å‹•è©"/>ã§ã™ã€‚<T t="è¦š"/>ãˆã¡ã‚ƒãŠã†ï¼</p>
                <div className="grid grid-cols-2 gap-2 text-center font-bold">
                    <div className="bg-rose-50 p-2 rounded border border-rose-100 shadow-sm">go â†’ <span className="text-rose-600 text-lg">went</span></div>
                    <div className="bg-rose-50 p-2 rounded border border-rose-100 shadow-sm">come â†’ <span className="text-rose-600 text-lg">came</span></div>
                    <div className="bg-rose-50 p-2 rounded border border-rose-100 shadow-sm">eat â†’ <span className="text-rose-600 text-lg">ate</span></div>
                    <div className="bg-rose-50 p-2 rounded border border-rose-100 shadow-sm">have â†’ <span className="text-rose-600 text-lg">had</span></div>
                    <div className="bg-rose-50 p-2 rounded border border-rose-100 shadow-sm">see â†’ <span className="text-rose-600 text-lg">saw</span></div>
                    <div className="bg-rose-50 p-2 rounded border border-rose-100 shadow-sm">buy â†’ <span className="text-rose-600 text-lg">bought</span></div>
                    <div className="bg-rose-50 p-2 rounded border border-rose-100 shadow-sm">do â†’ <span className="text-rose-600 text-lg">did</span></div>
                    <div className="bg-rose-50 p-2 rounded border border-rose-100 shadow-sm">make â†’ <span className="text-rose-600 text-lg">made</span></div>
                </div>
            </div>
        )
    },
    "hint_can": {
        title: "åŠ©å‹•è© (Canãªã©)",
        content: (
            <div className="text-base bg-green-50 p-4 rounded-xl space-y-3 border border-green-100">
                <p><T t="å‹•è©"/>ã®å‰ã«<T t="ç½®"/>ã„ã¦ã€<T t="æ„å‘³"/>ã‚’<T t="è¶³"/>ã—ã¾ã™ã€‚</p>
                <ul className="list-disc list-inside font-bold space-y-1 text-lg">
                    <li><span className="text-green-700">Can</span> : ã€œã§ãã‚‹</li>
                    <li><span className="text-green-700">May</span> : ã€œã—ã¦ã‚‚ã‚ˆã„</li>
                    <li><span className="text-green-700">Must</span> : ã€œã—ãªã‘ã‚Œã°ãªã‚‰ãªã„</li>
                </ul>
                <div className="bg-white p-3 rounded-lg border border-green-200 text-sm mt-2 shadow-sm">
                    <b className="text-green-800">ã ã„ã˜ãªãƒ«ãƒ¼ãƒ«:</b><br/>
                    1. <T t="å‹•è©"/>ã¯<T t="å…ƒ"/>ã®<T t="å½¢"/>ã«ã™ã‚‹ (sã¯ã¤ã‘ãªã„ï¼)<br/>
                    2. <T t="è³ªå•"/>ã¯ <b>Can you...?</b> ã®ã‚ˆã†ã«å‰ã«å‡ºã™
                </div>
            </div>
        )
    },
    "hint_wh": {
        title: "ç–‘å•è© (Wh-)",
        content: (
            <div className="text-base bg-violet-50 p-4 rounded-xl border border-violet-100">
                <p className="mb-2"><T t="è³ªå•"/>ã®<T t="æœ€åˆ"/>ã«<T t="ç½®"/>ã<T t="è¨€è‘‰"/>ã§ã™ã€‚</p>
                <div className="grid grid-cols-2 gap-3 font-bold">
                    <div className="bg-white p-2 rounded shadow-sm">What <span className="text-xs font-normal block text-gray-500">ãªã«</span></div>
                    <div className="bg-white p-2 rounded shadow-sm">Who <span className="text-xs font-normal block text-gray-500">ã ã‚Œ</span></div>
                    <div className="bg-white p-2 rounded shadow-sm">Where <span className="text-xs font-normal block text-gray-500">ã©ã“</span></div>
                    <div className="bg-white p-2 rounded shadow-sm">When <span className="text-xs font-normal block text-gray-500">ã„ã¤</span></div>
                    <div className="bg-white p-2 rounded shadow-sm">How <span className="text-xs font-normal block text-gray-500">ã©ã† / ã©ã®ãã‚‰ã„</span></div>
                    <div className="bg-white p-2 rounded shadow-sm">Why <span className="text-xs font-normal block text-gray-500">ãªãœ</span></div>
                </div>
                <div className="mt-3 text-sm bg-violet-100 p-2 rounded">
                    <b>How many</b> : ã„ãã¤ (<T t="æ•°"/>ã‚’èãã¨ã)
                </div>
            </div>
        )
    },
    "hint_preposition": {
        title: "å‰ç½®è© (å ´æ‰€)",
        content: (
            <div className="text-base bg-amber-50 p-4 rounded-xl border border-amber-100">
                <p className="mb-3">ãƒ¢ãƒãŒã©ã“ã«ã‚ã‚‹ã‹ã‚’è¡¨ã—ã¾ã™ã€‚</p>
                <div className="grid grid-cols-2 gap-3 text-center font-bold">
                    <div className="bg-white p-2 rounded shadow-sm">
                        <span className="text-amber-600 text-xl block">on</span>
                        <span className="text-sm">ã€œã®ä¸Šã«</span>
                        <span className="text-xs block text-gray-400">ğŸ“¦ã®ä¸Šã«ğŸ</span>
                    </div>
                    <div className="bg-white p-2 rounded shadow-sm">
                        <span className="text-amber-600 text-xl block">in</span>
                        <span className="text-sm">ã€œã®ä¸­ã«</span>
                        <span className="text-xs block text-gray-400">ğŸ“¦ã®ä¸­ã«ğŸ</span>
                    </div>
                    <div className="bg-white p-2 rounded shadow-sm">
                        <span className="text-amber-600 text-xl block">under</span>
                        <span className="text-sm">ã€œã®ä¸‹ã«</span>
                        <span className="text-xs block text-gray-400">ğŸ“¦ã®ä¸‹ã«ğŸ</span>
                    </div>
                    <div className="bg-white p-2 rounded shadow-sm">
                        <span className="text-amber-600 text-xl block">by</span>
                        <span className="text-sm">ã€œã®ãã°ã«</span>
                        <span className="text-xs block text-gray-400">ğŸ“¦ã®æ¨ªã«ğŸ</span>
                    </div>
                </div>
            </div>
        )
    },
    "hint_progressive": {
        title: "é€²è¡Œå½¢ (ã€œã—ã¦ã„ã‚‹)",
        content: (
            <div className="text-base bg-teal-50 p-4 rounded-xl border border-teal-100 space-y-3">
                <p>ã€Œä»Šã€ã€œã—ã¦ã„ã¾ã™ã€ã¨ã„ã†ã¨ãã¯ã“ã‚Œï¼</p>
                <div className="text-center bg-white p-3 rounded-lg shadow-sm border border-teal-200">
                    <span className="text-xl font-bold text-pink-500">Beå‹•è©</span>
                    <span className="mx-2 text-gray-400">+</span>
                    <span className="text-xl font-bold text-teal-600">ing</span>
                </div>
                <ul className="list-disc list-inside text-sm space-y-1 ml-2">
                    <li>I <b className="text-pink-500">am</b> play<b className="text-teal-600">ing</b>.</li>
                    <li>He <b className="text-pink-500">is</b> eat<b className="text-teal-600">ing</b>.</li>
                    <li>They <b className="text-pink-500">are</b> runn<b className="text-teal-600">ing</b>.</li>
                </ul>
            </div>
        )
    },
    "hint_plural": {
        title: "è¤‡æ•°å½¢ (2ã¤ä»¥ä¸Š)",
        content: (
            <div className="text-base bg-indigo-50 p-4 rounded-xl border border-indigo-100">
                <p>ãƒ¢ãƒãŒ2ã¤<T t="ä»¥ä¸Š"/>ã‚ã‚‹ã¨ãã¯ã€åå‰ã®å¾Œã‚ã« <b>s</b> ã‹ <b>es</b> ã‚’ã¤ã‘ã¾ã™ã€‚</p>
                <div className="mt-3 grid grid-cols-1 gap-2 font-bold">
                    <div className="bg-white px-3 py-1 rounded flex justify-between"><span>apple (1ã¤)</span> <span>â†’</span> <span className="text-indigo-600">apples</span></div>
                    <div className="bg-white px-3 py-1 rounded flex justify-between"><span>box (ç®±)</span> <span>â†’</span> <span className="text-indigo-600">boxes</span></div>
                    <div className="bg-white px-3 py-1 rounded flex justify-between"><span>child (å­ä¾›)</span> <span>â†’</span> <span className="text-indigo-600">children</span> <span className="text-[10px] text-red-400">(ã¨ãã¹ã¤)</span></div>
                </div>
            </div>
        )
    },
    "hint_there": {
        title: "There is æ§‹æ–‡",
        content: (
            <div className="text-base bg-lime-50 p-4 rounded-xl border border-lime-100 space-y-2">
                <p>ã€Œã€œãŒã‚ã‚Šã¾ã™ / ã„ã¾ã™ã€ã¨ã„ã†æ–‡ã§ã™ã€‚</p>
                <ul className="space-y-2">
                    <li className="bg-white p-2 rounded shadow-sm">
                        <b>There is ...</b><br/>
                        <span className="text-sm">1ã¤ã®ã‚‚ã®ãŒã‚ã‚‹ã¨ã</span>
                    </li>
                    <li className="bg-white p-2 rounded shadow-sm">
                        <b>There are ...</b><br/>
                        <span className="text-sm">2ã¤<T t="ä»¥ä¸Š"/>ã®ã‚‚ã®ãŒã‚ã‚‹ã¨ã</span>
                    </li>
                </ul>
                <p className="text-sm mt-2">
                    <span className="bg-red-100 px-1 rounded"><T t="å¦å®š"/></span> There is <b>not</b>... (ã‚ã‚Šã¾ã›ã‚“)<br/>
                    <span className="bg-blue-100 px-1 rounded"><T t="ç–‘å•"/></span> <b>Is</b> there...? (ã‚ã‚Šã¾ã™ã‹ï¼Ÿ)
                </p>
            </div>
        )
    },
    "hint_demo": {
        title: "ã“ã‚Œ / ã‚ã‚Œ",
        content: (
            <div className="text-base bg-yellow-50 p-4 rounded-xl border border-yellow-100">
                <div className="grid grid-cols-2 gap-4 text-center">
                    <div>
                        <div className="text-sm text-gray-500 mb-1">è¿‘ã (ã“ã‚Œ)</div>
                        <div className="bg-white p-2 rounded font-bold text-lg mb-2 shadow-sm text-yellow-700">This</div>
                        <div className="text-xs"><T t="è¤‡"/>æ•°ã¯ <b className="text-yellow-700 text-sm">These</b></div>
                    </div>
                    <div>
                        <div className="text-sm text-gray-500 mb-1">é ã (ã‚ã‚Œ)</div>
                        <div className="bg-white p-2 rounded font-bold text-lg mb-2 shadow-sm text-yellow-700">That</div>
                        <div className="text-xs"><T t="è¤‡"/>æ•°ã¯ <b className="text-yellow-700 text-sm">Those</b></div>
                    </div>
                </div>
            </div>
        )
    },
};

// --- Generators ---
const ALL_SUBJECTS = ["I", "You", "He", "She", "We", "They", "Taro", "Hanako", "Ken", "My father", "My mother", "The dog", "The cat", "Mr. Suzuki"];
const SINGULAR_SUBJECTS = ["He", "She", "Taro", "Hanako", "Ken", "My father", "My mother", "The dog", "The cat", "Mr. Suzuki"];
const BE_Q_SUBJECTS = ["I", "you", "he", "she", "we", "they", "Taro", "Hanako", "Ken", "your father", "your mother"];

const getJPSubj = (s) => {
    const map = {
        "I": "ç§", "You": "ã‚ãªãŸ", "He": "å½¼", "She": "å½¼å¥³", "We": "ç§ãŸã¡", "They": "å½¼ã‚‰",
        "Taro": "ã‚¿ãƒ­ã‚¦ãã‚“", "Hanako": "ãƒãƒŠã‚³ã•ã‚“", "Ken": "ã‚±ãƒ³ãã‚“", "My father": "ç§ã®ãŠçˆ¶ã•ã‚“", "My mother": "ç§ã®ãŠæ¯ã•ã‚“",
        "The dog": "ãã®çŠ¬", "The cat": "ãã®çŒ«", "Mr. Suzuki": "ã‚¹ã‚ºã‚­å…ˆç”Ÿ",
        "your father": "ã‚ãªãŸã®ãŠçˆ¶ã•ã‚“", "your mother": "ã‚ãªãŸã®ãŠæ¯ã•ã‚“"
    };
    return map[s] ? map[s] + "ã¯" : s + "ã¯";
};
const jpPlaceNi = (p) => {
    const map = { "at home":"å®¶ã«", "at school":"å­¦æ ¡ã«", "in the park":"å…¬åœ’ã«", "at the library":"å›³æ›¸é¤¨ã«", "in the kitchen":"å°æ‰€ã«", "in the garden":"åº­ã«", "in my room":"ç§ã®éƒ¨å±‹ã«" };
    return map[p] || p;
};
const jpTime = (t) => ({ "yesterday": "æ˜¨æ—¥", "last night": "æ˜¨å¤œ", "this morning": "ä»Šæœ", "on Sunday": "æ—¥æ›œæ—¥ã«" }[t] || t);

const rand = (arr) => arr[Math.floor(Math.random() * arr.length)];
const shuffle = (arr) => arr.slice().sort(() => Math.random() - 0.5);
const ensureFourChoices = (arr) => {
    let choices = Array.from(new Set(arr));
    const correct = choices[0];
    let others = choices.slice(1);
    if (choices.length < 4) return shuffle(choices);
    if (others.length >= 3) others = shuffle(others).slice(0, 3);
    return shuffle([correct, ...others]);
};

const genBeVerbPresent = () => { const subj = rand(ALL_SUBJECTS); const place = rand(["at home", "at school", "in the park", "in the kitchen"]); const correct = subj === "I" ? "am" : SINGULAR_SUBJECTS.includes(subj) ? "is" : "are"; return { type: "choice", en: `${subj} ___ ${place}.`, choices: ["am", "is", "are", "was"], correctAnswerText: correct, explainJP: "Iâ†’am, He/Sheâ†’is, You/We/Theyâ†’are ã§ã™ã€‚", speak: `${subj} ${correct} ${place}.`, jp: `${getJPSubj(subj)} ${jpPlaceNi(place)} ã„ã¾ã™ã€‚` }; };
const genBeVerbPast = () => { const subj = rand(ALL_SUBJECTS); const t = rand(["yesterday", "last night"]); const correct = (subj === "I" || SINGULAR_SUBJECTS.includes(subj)) ? "was" : "were"; return { type: "choice", en: `${subj} ___ happy ${t}.`, choices: ["was", "were", "am", "is"], correctAnswerText: correct, explainJP: "éå»ã®ã“ã¨ã¯ was ã‹ were ã‚’ä½¿ã„ã¾ã™ã€‚", speak: `${subj} ${correct} happy ${t}.`, jp: `${getJPSubj(subj)} ${jpTime(t)} å¹¸ã›ã§ã—ãŸã€‚` }; };
const genBeQuestion = () => { const subj = rand(BE_Q_SUBJECTS); const place = rand(["at home", "at school", "in the park"]); const correct = subj === "I" ? "Am" : (["he", "she", "Taro", "Hanako", "Ken"].includes(subj) || subj.includes("father") || subj.includes("mother")) ? "Is" : "Are"; return { type: "choice", en: `___ ${subj} ${place}?`, choices: ["Am", "Is", "Are"], correctAnswerText: correct, explainJP: "è³ªå•ã¯ Am/Is/Are ã§å§‹ã‚ã¾ã™ã€‚", speak: `${correct} ${subj} ${place}?`, jp: `${getJPSubj(subj)} ${jpPlaceNi(place)} ã„ã¾ã™ã‹ï¼Ÿ` }; };
const genBeMaster = () => rand([genBeVerbPresent, genBeVerbPast, genBeQuestion])();
const PRESENT_PAIRS = [ { v: "play", tail: "soccer", jp: "ã‚µãƒƒã‚«ãƒ¼ã‚’ã—ã¾ã™" }, { v: "watch", tail: "TV", jp: "ãƒ†ãƒ¬ãƒ“ã‚’ã¿ã¾ã™" }, { v: "eat", tail: "lunch", jp: "ãŠæ˜¼ã”é£¯ã‚’é£Ÿã¹ã¾ã™" }, { v: "study", tail: "English", jp: "è‹±èªã‚’å‹‰å¼·ã—ã¾ã™" }, { v: "run", tail: "fast", jp: "é€Ÿãèµ°ã‚Šã¾ã™" }, { v: "cook", tail: "dinner", jp:"å¤•é£Ÿã‚’ä½œã‚Šã¾ã™" } ];
const genVerbPresent = () => { const subj = rand(ALL_SUBJECTS); const pair = rand(PRESENT_PAIRS); const isSanTanGen = SINGULAR_SUBJECTS.includes(subj); const correct = isSanTanGen ? (pair.v.endsWith('ch')||pair.v.endsWith('o')?pair.v+"es":pair.v+"s") : pair.v; const wrong = isSanTanGen ? pair.v : (pair.v.endsWith('ch')||pair.v.endsWith('o')?pair.v+"es":pair.v+"s"); return { type: "choice", en: `${subj} ___ ${pair.tail}.`, choices: [correct, wrong, pair.v+"ed", pair.v+"ing"], correctAnswerText: correct, explainJP: "ä¸»èªãŒä¸€äºº(He/She/Taroãªã©)ã®ã¨ãã¯ã€å‹•è©ã« s ã‹ es ã‚’ã¤ã‘ã¾ã™ã€‚", speak: `${subj} ${correct} ${pair.tail}.`, jp: `${getJPSubj(subj)} ${pair.jp}ã€‚` }; };
const genVerbPast = () => { const subj = rand(ALL_SUBJECTS); const t = rand(["yesterday", "last night"]); const REG_PAIRS = [{v:"play",p:"played",jp:"ã‚µãƒƒã‚«ãƒ¼ã‚’ã—ã¾ã—ãŸ",t:"soccer"}, {v:"watch",p:"watched",jp:"ãƒ†ãƒ¬ãƒ“ã‚’è¦‹ã¾ã—ãŸ",t:"TV"}, {v:"cook",p:"cooked",jp:"å¤•é£Ÿã‚’ä½œã‚Šã¾ã—ãŸ",t:"dinner"}, {v:"wash",p:"washed",jp:"æ´—ã„ã¾ã—ãŸ",t:"the car"}]; const p = rand(REG_PAIRS); return { type: "choice", en: `${subj} ___ ${p.t} ${t}.`, choices: [p.p, p.v, p.v+"s", p.v+"ing"], correctAnswerText: p.p, explainJP: "éå»ã®ã“ã¨ã¯ã€å‹•è©ã«edã‚’ã¤ã‘ã¾ã™ã€‚", speak: `${subj} ${p.p} ${p.t} ${t}.`, jp: `${getJPSubj(subj)} ${jpTime(t)} ${p.jp}ã€‚` }; };
const genVerbIrregular = () => { const subj = rand(ALL_SUBJECTS); const t = rand(["yesterday", "last night"]); const IRR_PAIRS = [ {base:"go",past:"went",tail:"to school",jp:"å­¦æ ¡ã¸è¡Œãã¾ã—ãŸ"}, {base:"eat",past:"ate",tail:"lunch",jp:"ãŠæ˜¼ã‚’é£Ÿã¹ã¾ã—ãŸ"}, {base:"see",past:"saw",tail:"a bird",jp:"é³¥ã‚’è¦‹ã¾ã—ãŸ"}, {base:"come",past:"came",tail:"home",jp:"å®¶ã«å¸°ã£ã¦ãã¾ã—ãŸ"}, {base:"have",past:"had",tail:"a good time",jp:"æ¥½ã—ãéã”ã—ã¾ã—ãŸ"}, {base:"buy",past:"bought",tail:"a book",jp:"æœ¬ã‚’è²·ã„ã¾ã—ãŸ"} ]; const v = rand(IRR_PAIRS); return { type: "choice", en: `${subj} ___ ${v.tail} ${t}.`, choices: [v.past, v.base+"ed", v.base, "goes"], correctAnswerText: v.past, explainJP: "ä¸è¦å‰‡å‹•è©ã¯å½¢ãŒç‰¹åˆ¥ã«å¤‰ã‚ã‚Šã¾ã™ã€‚", speak: `${subj} ${v.past} ${v.tail} ${t}.`, jp: `${getJPSubj(subj)} ${jpTime(t)} ${v.jp}ã€‚` }; };
const genVerbQuestion = () => { const subj = rand(["you", "he", "she", "Taro"]); const pair = rand(PRESENT_PAIRS); const correct = (["he","she","taro"].includes(subj.toLowerCase())) ? "Does" : "Do"; return { type: "choice", en: `___ ${subj} ${pair.v} ${pair.tail}?`, choices: ["Do", "Does", "Did", "Is"], correctAnswerText: correct, explainJP: "He/Sheãªã©ã¯Doesã€ãã‚Œä»¥å¤–ã¯Doã‚’ä½¿ã„ã¾ã™ã€‚", speak: `${correct} ${subj} ${pair.v} ${pair.tail}?`, jp: `${getJPSubj(subj)} ${pair.jp}ã‹ï¼Ÿ` }; };
const genDidQuestion = () => { const subj = rand(["you", "he", "she"]); const t = rand(["yesterday", "last night"]); const v = rand(PRESENT_PAIRS); return { type: "choice", en: `Did ${subj} ___ ${v.tail} ${t}?`, choices: [v.v, v.v+"ed", "went", "ate"], correctAnswerText: v.v, explainJP: "Didã‚’ä½¿ã£ãŸè³ªå•æ–‡ã§ã¯ã€å‹•è©ã¯å…ƒã®å½¢ã«æˆ»ã‚Šã¾ã™ã€‚", speak: `Did ${subj} ${v.v} ${v.tail} ${t}?`, jp: `${getJPSubj(subj)} ${jpTime(t)} ${v.jp}ã‹ï¼Ÿ` }; };
const genVerbMaster = () => rand([genVerbPresent, genVerbPast, genVerbIrregular, genVerbQuestion, genDidQuestion])();
const genCan = () => { const subj = rand(ALL_SUBJECTS); const act = rand([{en:"swim",jp:"æ³³ã’ã‚‹"},{en:"run fast",jp:"é€Ÿãèµ°ã‚Œã‚‹"},{en:"speak English",jp:"è‹±èªã‚’è©±ã›ã‚‹"}]); return { type: "choice", en: `${subj} ___ ${act.en}.`, choices: ["can", "is", "do", "cans"], correctAnswerText: "can", explainJP: "ã€Œã€œã§ãã‚‹ã€ã¯ can ã‚’ä½¿ã„ã¾ã™ã€‚sã¯ã¤ãã¾ã›ã‚“ã€‚", speak: `${subj} can ${act.en}.`, jp: `${getJPSubj(subj)} ${act.jp}ã€‚` }; };
const genAuxMix = () => { const pool = [ { en: "I ___ swim.", ans: "can", jp: "ç§ã¯æ³³ã’ã¾ã™ã€‚", choices: ["can", "may", "must", "is"] }, { en: "You ___ study hard.", ans: "must", jp: "ã‚ãªãŸã¯ä¸€ç”Ÿæ‡¸å‘½å‹‰å¼·ã—ãªã‘ã‚Œã°ãªã‚Šã¾ã›ã‚“ã€‚", choices: ["must", "may", "can", "am"] }, { en: "___ I come in?", ans: "May", jp: "å…¥ã£ã¦ã‚‚ã„ã„ã§ã™ã‹ï¼Ÿ", choices: ["May", "Must", "Am", "Do"] }, { en: "He ___ run fast.", ans: "can", jp: "å½¼ã¯é€Ÿãèµ°ã‚Œã¾ã™ã€‚", choices: ["can", "must", "may", "is"] } ]; const q = rand(pool); return { type: "choice", en: q.en, choices: shuffle(q.choices), correctAnswerText: q.ans, explainJP: "Can(ã§ãã‚‹), Must(ã—ãªã‘ã‚Œã°ãªã‚‰ãªã„), May(ã—ã¦ã‚‚ã‚ˆã„) ã‚’ä½¿ã„åˆ†ã‘ã‚ˆã†ã€‚", speak: q.en.replace('___', q.ans), jp: q.jp }; };
const genWh = () => { const q = rand([ {wh:"What",tail:"is this?",jp:"ã“ã‚Œã¯ä½•ã§ã™ã‹ï¼Ÿ"}, {wh:"Who",tail:"is he?",jp:"å½¼ã¯ã ã‚Œã§ã™ã‹ï¼Ÿ"}, {wh:"Where",tail:"is my book?",jp:"ç§ã®æœ¬ã¯ã©ã“ï¼Ÿ"}, {wh:"When",tail:"is your birthday?",jp:"èª•ç”Ÿæ—¥ã¯ã„ã¤ï¼Ÿ"}, {wh:"How",tail:"are you?",jp:"å…ƒæ°—ã§ã™ã‹ï¼Ÿ(èª¿å­ã¯ã©ã†ï¼Ÿ)"}, {wh:"How",tail:"many apples?",jp:"ãƒªãƒ³ã‚´ã¯ã„ãã¤(ä½•å€‹)ï¼Ÿ"} ]); return { type: "choice", en: `___ ${q.tail}`, choices: ["What", "Who", "Where", "When", "How"], correctAnswerText: q.wh, explainJP: "What(ãªã«), Who(ã ã‚Œ), Where(ã©ã“), When(ã„ã¤), How(ã©ã†) ã‚’é¸ã¼ã†ã€‚", speak: `${q.wh} ${q.tail}`, jp: `${q.jp}` }; };
const genPreposition = () => { const s = rand([ {p:"on", en:"on the desk", jp:"æœºã®ä¸Šã«"}, {p:"in", en:"in the box", jp:"ç®±ã®ä¸­ã«"}, {p:"under", en:"under the table", jp:"ãƒ†ãƒ¼ãƒ–ãƒ«ã®ä¸‹ã«"}, {p:"by", en:"by the door", jp:"ãƒ‰ã‚¢ã®ãã°ã«"} ]); return { type: "choice", en: `The pen is ___ ${s.en.replace(s.p + ' ', '')}.`, choices: ["on", "in", "under", "by"], correctAnswerText: s.p, explainJP: "å ´æ‰€ã‚’è¡¨ã™è¨€è‘‰ã§ã™ã€‚", speak: `The pen is ${s.en}.`, jp: `ãƒšãƒ³ã¯${s.jp}ã‚ã‚Šã¾ã™ã€‚` }; };
const genPlural = () => { const n = rand([{s:"apple",p:"apples"},{s:"box",p:"boxes"},{s:"dog",p:"dogs"},{s:"child",p:"children"}]); const num = Math.floor(Math.random()*3)+2; return { type: "choice", en: `I have ${num} ___.`, choices: [n.p, n.s, n.s+"s", n.p+"s"], correctAnswerText: n.p, explainJP: "2ã¤ä»¥ä¸Šã®ã¨ãã¯ã€è¤‡æ•°å½¢(sã‚„esãŒã¤ãå½¢)ã«ã—ã¾ã™ã€‚", speak: `I have ${num} ${n.p}.`, jp: `ç§ã¯${num}å€‹ã®${n.s.replace('apple','ãƒªãƒ³ã‚´').replace('box','ç®±').replace('dog','çŠ¬').replace('child','å­ä¾›')}ã‚’æŒã£ã¦ã„ã¾ã™ã€‚` }; };
const genProgressive = () => { const subj = rand(ALL_SUBJECTS); const act = rand([{ing:"playing",jp:"ã—ã¦ã„ã¾ã™"},{ing:"eating",jp:"é£Ÿã¹ã¦ã„ã¾ã™"},{ing:"reading",jp:"èª­ã‚“ã§ã„ã¾ã™"}]); const be = (subj === "I") ? "am" : (SINGULAR_SUBJECTS.includes(subj) ? "is" : "are"); return { type: "choice", en: `${subj} ${be} ___ now.`, choices: [act.ing, act.ing.replace('ing',''), "play", "eat"], correctAnswerText: act.ing, explainJP: "ã€Œä»Šã€œã—ã¦ã„ã¾ã™ã€ã¯ã€beå‹•è© + ing ã®å½¢ã§ã™ã€‚", speak: `${subj} ${be} ${act.ing} now.`, jp: `${getJPSubj(subj)} ä»Š ã€œ${act.jp}ã€‚` }; };
const genThere = () => { const type = rand(['aff', 'neg', 'q', 'past']); let en, correct, choices, jp, explain; const isSin = Math.random() < 0.5; const noun = isSin ? "an apple" : "two apples"; if (type === 'q') { correct = isSin ? "Is" : "Are"; en = `___ there ${noun}?`; choices = ["Is", "Are", "Do", "Does"]; jp = `${noun.replace('an apple','ãƒªãƒ³ã‚´ãŒ1ã¤').replace('two apples','ãƒªãƒ³ã‚´ãŒ2ã¤')}ã‚ã‚Šã¾ã™ã‹ï¼Ÿ`; explain = "è³ªå•ã™ã‚‹ã¨ãã¯ã€Is ã‹ Are ã‚’å‰ã«å‡ºã—ã¾ã™ã€‚"; } else if (type === 'neg') { correct = "not"; en = `There is ___ ${noun.replace('two','any')}.`; choices = ["not", "no", "is", "are"]; jp = `${noun.replace('an apple','ãƒªãƒ³ã‚´ãŒ').replace('two apples','ãƒªãƒ³ã‚´ãŒ')}ã‚ã‚Šã¾ã›ã‚“ã€‚`; explain = "ã€Œã‚ã‚Šã¾ã›ã‚“ã€ã¯ is not ã‚’ä½¿ã„ã¾ã™ã€‚"; } else if (type === 'past') { correct = isSin ? "was" : "were"; en = `There ___ ${noun} yesterday.`; choices = ["was", "were", "is", "are"]; jp = `æ˜¨æ—¥ã€${noun.replace('an apple','ãƒªãƒ³ã‚´ãŒ1ã¤').replace('two apples','ãƒªãƒ³ã‚´ãŒ2ã¤')}ã‚ã‚Šã¾ã—ãŸã€‚`; explain = "æ˜”ã®ã“ã¨ã¯ã€isâ†’wasã€areâ†’were ã«å¤‰ãˆã¾ã™ã€‚"; } else { correct = isSin ? "is" : "are"; en = `There ___ ${noun}.`; choices = ["is", "are", "have", "am"]; jp = `${noun.replace('an apple','ãƒªãƒ³ã‚´ãŒ1ã¤').replace('two apples','ãƒªãƒ³ã‚´ãŒ2ã¤')}ã‚ã‚Šã¾ã™ã€‚`; explain = "1ã¤ãªã‚‰isã€2ã¤ä»¥ä¸Šãªã‚‰areã‚’ä½¿ã„ã¾ã™ã€‚"; } return { type: "choice", en, choices, correctAnswerText: correct, explainJP: explain, speak: en.replace('___', correct), jp }; };
const genDemo = () => { const type = rand(['std', 'q', 'adj']); const isPlural = Math.random() < 0.5; const isNear = Math.random() < 0.5; const noun = isPlural ? "books" : "book"; const be = isPlural ? "are" : "is"; let correct, en, choices, jp, explain; if (type === 'adj') { const adj = "red"; correct = isPlural ? (isNear?"These":"Those") : (isNear?"This":"That"); en = `___ ${noun} ${be} ${adj}.`; choices = ["This", "That", "These", "Those"]; jp = `${isNear?'ã“ã‚Œ':'ã‚ã‚Œ'}${isPlural?'ã‚‰':''}ã¯èµ¤ã„æœ¬ã§ã™ã€‚`; explain = "ã€Œèµ¤ã„æœ¬ã€ãªã©ã®èª¬æ˜ãŒã¤ã„ã¦ã‚‚ã€åŸºæœ¬ã¯åŒã˜ã§ã™ã€‚"; } else if (type === 'q') { correct = isPlural ? (isNear?"These":"Those") : (isNear?"This":"That"); en = `${isPlural?'Are':'Is'} ___ your ${noun}?`; choices = ["This", "That", "These", "Those"]; jp = `${isNear?'ã“ã‚Œ':'ã‚ã‚Œ'}${isPlural?'ã‚‰':''}ã¯ã‚ãªãŸã®æœ¬ã§ã™ã‹ï¼Ÿ`; explain = "è³ªå•æ–‡ã§ã‚‚ã€ã“ã‚Œ(This/These)ã¨ã‚ã‚Œ(That/Those)ã®ä½¿ã„åˆ†ã‘ã¯åŒã˜ã§ã™ã€‚"; } else { correct = isPlural ? (isNear?"These":"Those") : (isNear?"This":"That"); en = `___ ${be} a ${noun}.`.replace('a books', 'books'); choices = ["This", "That", "These", "Those"]; jp = `${isNear?'ã“ã‚Œ':'ã‚ã‚Œ'}${isPlural?'ã‚‰':''}ã¯æœ¬ã§ã™ã€‚`; explain = "ã“ã‚Œ(This/These) ã¨ ã‚ã‚Œ(That/Those)ã€‚æ•°ã‚’ã‚ˆãè¦‹ã¦ã­ã€‚"; } return { type: "choice", en, choices, correctAnswerText: correct, explainJP: explain, speak: en.replace('___', correct), jp }; };

const LESSON_GROUPS = [
    { id: "be_group", name: "Beå‹•è©", bg: "bg-pink-50", border: "border-pink-300", text: "text-pink-800", icon: "ğŸŒ¸" },
    { id: "verb_group", name: "ä¸€èˆ¬å‹•è©", bg: "bg-sky-50", border: "border-sky-300", text: "text-sky-800", icon: "ğŸƒ" },
    { id: "grammar_group", name: "åŸºæœ¬ã®æ–‡æ³•", bg: "bg-green-50", border: "border-green-300", text: "text-green-800", icon: "ğŸ€" },
    { id: "advance_group", name: "ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—", bg: "bg-violet-50", border: "border-violet-300", text: "text-violet-800", icon: "ğŸš€" }
];

const LESSONS = [
  { id: "be-present", groupId: "be_group", hintId: "hint_be", name: "Beå‹•è© (ç¾åœ¨)", generator: genBeVerbPresent, icon: "ğŸ˜Š" },
  { id: "be-past", groupId: "be_group", hintId: "hint_be", name: "Beå‹•è© (éå»)", generator: genBeVerbPast, icon: "ğŸ•°ï¸" },
  { id: "be-question", groupId: "be_group", hintId: "hint_be", name: "Beå‹•è© (ç–‘å•)", generator: genBeQuestion, icon: "ğŸ¤”" },
  { id: "be-master", groupId: "be_group", hintId: "hint_be", name: "Beå‹•è© ã¾ã¨ã‚", generator: genBeMaster, icon: "ğŸ‘‘" },
  { id: "verb-present", groupId: "verb_group", hintId: "hint_verb_present", name: "ä¸€èˆ¬å‹•è© (ç¾åœ¨)", generator: genVerbPresent, icon: "âš½" },
  { id: "verb-past", groupId: "verb_group", hintId: "hint_verb_past", name: "ä¸€èˆ¬å‹•è© (éå»)", generator: genVerbPast, icon: "ğŸ”™" },
  { id: "verb-irregular", groupId: "verb_group", hintId: "hint_verb_irregular", name: "ä¸€èˆ¬å‹•è© (ä¸è¦å‰‡)", generator: genVerbIrregular, icon: "ğŸ”¥" },
  { id: "verb-question", groupId: "verb_group", hintId: "hint_verb_present", name: "ä¸€èˆ¬å‹•è© (ç–‘å•)", generator: genVerbQuestion, icon: "â“" },
  { id: "verb-did", groupId: "verb_group", hintId: "hint_verb_past", name: "Didã®æ–‡", generator: genDidQuestion, icon: "ğŸ”™" },
  { id: "verb-master", groupId: "verb_group", hintId: "hint_verb_present", name: "ä¸€èˆ¬å‹•è© ã¾ã¨ã‚", generator: genVerbMaster, icon: "ğŸ‘‘" },
  { id: "can", groupId: "grammar_group", hintId: "hint_can", name: "åŠ©å‹•è© Can", generator: genCan, icon: "ğŸ’ª" },
  { id: "aux-mix", groupId: "grammar_group", hintId: "hint_can", name: "åŠ©å‹•è© ãƒŸãƒƒã‚¯ã‚¹", generator: genAuxMix, icon: "ğŸ¦¸" },
  { id: "wh", groupId: "grammar_group", hintId: "hint_wh", name: "ç–‘å•è© (Wh)", generator: genWh, icon: "ğŸ•µï¸" },
  { id: "preposition", groupId: "grammar_group", hintId: "hint_preposition", name: "å‰ç½®è© (å ´æ‰€)", generator: genPreposition, icon: "ğŸ“¦" },
  { id: "progressive", groupId: "advance_group", hintId: "hint_progressive", name: "é€²è¡Œå½¢ (ing)", generator: genProgressive, icon: "ğŸƒ" },
  { id: "plural", groupId: "advance_group", hintId: "hint_plural", name: "è¤‡æ•°å½¢ (s/es)", generator: genPlural, icon: "ğŸ" },
  { id: "there", groupId: "advance_group", hintId: "hint_there", name: "There is æ§‹æ–‡", generator: genThere, icon: "ğŸ‘‰" },
  { id: "demo", groupId: "advance_group", hintId: "hint_demo", name: "This / These", generator: genDemo, icon: "ğŸ–Šï¸" },
];

const CARDS = [
  // N (Normal) - 20 kinds
  { id: "c_ant", name: "ã‚ã‚Š", emoji: "ğŸœ", rarity: "N" }, { id: "c_bee", name: "ã¯ã¡", emoji: "ğŸ", rarity: "N" }, { id: "c_cat", name: "ã­ã“", emoji: "ğŸ±", rarity: "N" }, { id: "c_dog", name: "ã„ã¬", emoji: "ğŸ¶", rarity: "N" }, { id: "c_fish", name: "ã•ã‹ãª", emoji: "ğŸŸ", rarity: "N" }, { id: "c_frog", name: "ã‹ãˆã‚‹", emoji: "ğŸ¸", rarity: "N" }, { id: "c_chick", name: "ã²ã‚ˆã“", emoji: "ğŸ¤", rarity: "N" }, { id: "c_pig", name: "ã¶ãŸ", emoji: "ğŸ·", rarity: "N" }, { id: "c_mouse", name: "ã­ãšã¿", emoji: "ğŸ­", rarity: "N" }, { id: "c_flower", name: "ã¯ãª", emoji: "ğŸŒ¸", rarity: "N" }, { id: "c_tree", name: "ã", emoji: "ğŸŒ³", rarity: "N" }, { id: "c_sun", name: "ãŸã„ã‚ˆã†", emoji: "â˜€ï¸", rarity: "N" }, { id: "c_moon", name: "ã¤ã", emoji: "ğŸŒ™", rarity: "N" }, { id: "c_star", name: "ã»ã—", emoji: "â­", rarity: "N" }, { id: "c_apple", name: "ãƒªãƒ³ã‚´", emoji: "ğŸ", rarity: "N" }, { id: "c_car", name: "ãã‚‹ã¾", emoji: "ğŸš—", rarity: "N" }, { id: "c_hamster", name: "ãƒãƒ ã‚¹ã‚¿ãƒ¼", emoji: "ğŸ¹", rarity: "N" }, { id: "c_rabbit", name: "ã†ã•ã", emoji: "ğŸ°", rarity: "N" }, { id: "c_cloud", name: "ãã‚‚", emoji: "â˜ï¸", rarity: "N" }, { id: "c_shell", name: "ã‹ã„ãŒã‚‰", emoji: "ğŸš", rarity: "N" },
  // R (Rare) - 20 kinds
  { id: "c_lion", name: "ãƒ©ã‚¤ã‚ªãƒ³", emoji: "ğŸ¦", rarity: "R" }, { id: "c_tiger", name: "ãƒˆãƒ©", emoji: "ğŸ¯", rarity: "R" }, { id: "c_bear", name: "ã‚¯ãƒ", emoji: "ğŸ»", rarity: "R" }, { id: "c_panda", name: "ãƒ‘ãƒ³ãƒ€", emoji: "ğŸ¼", rarity: "R" }, { id: "c_fox", name: "ã‚­ãƒ„ãƒ", emoji: "ğŸ¦Š", rarity: "R" }, { id: "c_koala", name: "ã‚³ã‚¢ãƒ©", emoji: "ğŸ¨", rarity: "R" }, { id: "c_monkey", name: "ã‚µãƒ«", emoji: "ğŸµ", rarity: "R" }, { id: "c_penguin", name: "ãƒšãƒ³ã‚®ãƒ³", emoji: "ğŸ§", rarity: "R" }, { id: "c_owl", name: "ãƒ•ã‚¯ãƒ­ã‚¦", emoji: "ğŸ¦‰", rarity: "R" }, { id: "c_cow", name: "ã‚¦ã‚·", emoji: "ğŸ®", rarity: "R" }, { id: "c_sheep", name: "ãƒ’ãƒ„ã‚¸", emoji: "ğŸ‘", rarity: "R" }, { id: "c_horse", name: "ã‚¦ãƒ", emoji: "ğŸ´", rarity: "R" }, { id: "c_squirrel", name: "ãƒªã‚¹", emoji: "ğŸ¿ï¸", rarity: "R" }, { id: "c_raccoon", name: "ã‚¢ãƒ©ã‚¤ã‚°ãƒ", emoji: "ğŸ¦", rarity: "R" }, { id: "c_skunk", name: "ã‚¹ã‚«ãƒ³ã‚¯", emoji: "ğŸ¦¨", rarity: "R" }, { id: "c_badger", name: "ã‚¢ãƒŠã‚°ãƒ", emoji: "ğŸ¦¡", rarity: "R" }, { id: "c_otter", name: "ã‚«ãƒ¯ã‚¦ã‚½", emoji: "ğŸ¦¦", rarity: "R" }, { id: "c_beaver", name: "ãƒ“ãƒ¼ãƒãƒ¼", emoji: "ğŸ¦«", rarity: "R" }, { id: "c_duck", name: "ã‚¢ãƒ’ãƒ«", emoji: "ğŸ¦†", rarity: "R" }, { id: "c_swan", name: "ãƒã‚¯ãƒãƒ§ã‚¦", emoji: "ğŸ¦¢", rarity: "R" },
  // SR (Super Rare) - 20 kinds
  { id: "c_wolf", name: "ã‚ªã‚ªã‚«ãƒŸ", emoji: "ğŸº", rarity: "SR" }, { id: "c_eagle", name: "ãƒ¯ã‚·", emoji: "ğŸ¦…", rarity: "SR" }, { id: "c_shark", name: "ã‚µãƒ¡", emoji: "ğŸ¦ˆ", rarity: "SR" }, { id: "c_whale", name: "ã‚¯ã‚¸ãƒ©", emoji: "ğŸ³", rarity: "SR" }, { id: "c_dolphin", name: "ã‚¤ãƒ«ã‚«", emoji: "ğŸ¬", rarity: "SR" }, { id: "c_dino", name: "æç«œ", emoji: "ğŸ¦–", rarity: "SR" }, { id: "c_croc", name: "ãƒ¯ãƒ‹", emoji: "ğŸŠ", rarity: "SR" }, { id: "c_snake", name: "ãƒ˜ãƒ“", emoji: "ğŸ", rarity: "SR" }, { id: "c_boar", name: "ã‚¤ãƒã‚·ã‚·", emoji: "ğŸ—", rarity: "SR" }, { id: "c_zebra", name: "ã‚·ãƒã‚¦ãƒ", emoji: "ğŸ¦“", rarity: "SR" }, { id: "c_deer", name: "ã‚·ã‚«", emoji: "ğŸ¦Œ", rarity: "SR" }, { id: "c_giraffe", name: "ã‚­ãƒªãƒ³", emoji: "ğŸ¦’", rarity: "SR" }, { id: "c_elephant", name: "ã‚¾ã‚¦", emoji: "ğŸ˜", rarity: "SR" }, { id: "c_rhino", name: "ã‚µã‚¤", emoji: "ğŸ¦", rarity: "SR" }, { id: "c_hippo", name: "ã‚«ãƒ", emoji: "ğŸ¦›", rarity: "SR" }, { id: "c_camel", name: "ãƒ©ã‚¯ãƒ€", emoji: "ğŸª", rarity: "SR" }, { id: "c_kangaroo", name: "ã‚«ãƒ³ã‚¬ãƒ«ãƒ¼", emoji: "ğŸ¦˜", rarity: "SR" }, { id: "c_lizard", name: "ãƒˆã‚«ã‚²", emoji: "ğŸ¦", rarity: "SR" }, { id: "c_turtle", name: "ã‚«ãƒ¡", emoji: "ğŸ¢", rarity: "SR" }, { id: "c_sloth", name: "ãƒŠãƒã‚±ãƒ¢ãƒ", emoji: "ğŸ¦¥", rarity: "SR" },
  // SSR (Double Super Rare) - 20 kinds
  { id: "c_dragon", name: "ãƒ‰ãƒ©ã‚´ãƒ³", emoji: "ğŸ‰", rarity: "SSR" }, { id: "c_uni", name: "ãƒ¦ãƒ‹ã‚³ãƒ¼ãƒ³", emoji: "ğŸ¦„", rarity: "SSR" }, { id: "c_phoenix", name: "ãƒ•ã‚§ãƒ‹ãƒƒã‚¯ã‚¹", emoji: "ğŸ”¥", rarity: "SSR" }, { id: "c_pegasus", name: "ãƒšã‚¬ã‚µã‚¹", emoji: "ğŸ", rarity: "SSR" }, { id: "c_ghost", name: "ã‚ªãƒã‚±", emoji: "ğŸ‘»", rarity: "SSR" }, { id: "c_alien", name: "å®‡å®™äºº", emoji: "ğŸ‘½", rarity: "SSR" }, { id: "c_octopus", name: "ã‚¿ã‚³", emoji: "ğŸ™", rarity: "SSR" }, { id: "c_squid", name: "ã‚¤ã‚«", emoji: "ğŸ¦‘", rarity: "SSR" }, { id: "c_crab", name: "ã‚«ãƒ‹", emoji: "ğŸ¦€", rarity: "SSR" }, { id: "c_shrimp", name: "ã‚¨ãƒ“", emoji: "ğŸ¦", rarity: "SSR" }, { id: "c_bat", name: "ã‚³ã‚¦ãƒ¢ãƒª", emoji: "ğŸ¦‡", rarity: "SSR" }, { id: "c_gorilla", name: "ã‚´ãƒªãƒ©", emoji: "ğŸ¦", rarity: "SSR" }, { id: "c_scorpion", name: "ã‚µã‚½ãƒª", emoji: "ğŸ¦‚", rarity: "SSR" }, { id: "c_spider", name: "ã‚¯ãƒ¢", emoji: "ğŸ•·ï¸", rarity: "SSR" }, { id: "c_butterfly", name: "ãƒãƒ§ã‚¦", emoji: "ğŸ¦‹", rarity: "SSR" }, { id: "c_seal", name: "ã‚¢ã‚¶ãƒ©ã‚·", emoji: "ğŸ¦­", rarity: "SSR" }, { id: "c_pbear", name: "ã‚·ãƒ­ã‚¯ãƒ", emoji: "ğŸ»â€â„ï¸", rarity: "SSR" }, { id: "c_bison", name: "ãƒã‚¤ã‚½ãƒ³", emoji: "ğŸƒ", rarity: "SSR" }, { id: "c_mammoth", name: "ãƒãƒ³ãƒ¢ã‚¹", emoji: "ğŸ¦£", rarity: "SSR" }, { id: "c_dodo", name: "ãƒ‰ãƒ¼ãƒ‰ãƒ¼", emoji: "ğŸ¦¤", rarity: "SSR" },
  // L (Legendary) - 20 kinds
  { id: "c_ufo", name: "UFO", emoji: "ğŸ›¸", rarity: "L" }, { id: "c_robot", name: "ãƒ­ãƒœãƒƒãƒˆ", emoji: "ğŸ¤–", rarity: "L" }, { id: "c_rocket", name: "ãƒ­ã‚±ãƒƒãƒˆ", emoji: "ğŸš€", rarity: "L" }, { id: "c_earth", name: "ã¡ãã‚…ã†", emoji: "ğŸŒ", rarity: "L" }, { id: "c_trex", name: "Tãƒ¬ãƒƒã‚¯ã‚¹", emoji: "ğŸ¦–", rarity: "L" }, { id: "c_sauro", name: "ãƒ–ãƒ©ã‚­ã‚ª", emoji: "ğŸ¦•", rarity: "L" }, { id: "c_comet", name: "ã™ã„ã›ã„", emoji: "â˜„ï¸", rarity: "L" }, { id: "c_volcano", name: "ã‹ã–ã‚“", emoji: "ğŸŒ‹", rarity: "L" }, { id: "c_galaxy", name: "ãã‚“ãŒ", emoji: "ğŸŒŒ", rarity: "L" }, { id: "c_hydra", name: "ãƒ’ãƒ‰ãƒ©", emoji: "ğŸ²", rarity: "L" }, { id: "c_cerberus", name: "ã‚±ãƒ«ãƒ™ãƒ­ã‚¹", emoji: "ğŸ•â€ğŸ¦º", rarity: "L" }, { id: "c_ninja", name: "ãƒ‹ãƒ³ã‚¸ãƒ£", emoji: "ğŸ¥·", rarity: "L" }, { id: "c_samurai", name: "ã‚µãƒ ãƒ©ã‚¤", emoji: "âš”ï¸", rarity: "L" }, { id: "c_blackhole", name: "ãƒ–ãƒ©ãƒƒã‚¯ãƒ›ãƒ¼ãƒ«", emoji: "âš«", rarity: "L" }, { id: "c_griffin", name: "ã‚°ãƒªãƒ•ã‚©ãƒ³", emoji: "ğŸ¦…ğŸ¦", rarity: "L" }, { id: "c_kraken", name: "ã‚¯ãƒ©ãƒ¼ã‚±ãƒ³", emoji: "ğŸ¦‘ğŸŒŠ", rarity: "L" }, { id: "c_saturn", name: "ã©ã›ã„", emoji: "ğŸª", rarity: "L" }, { id: "c_meteor", name: "ã„ã‚“ã›ã", emoji: "ğŸŒ ", rarity: "L" }, { id: "c_genie", name: "ã¾ã˜ã‚“", emoji: "ğŸ§", rarity: "L" }, { id: "c_fairy", name: "ã‚ˆã†ã›ã„", emoji: "ğŸ§š", rarity: "L" },
];
const RARITY_WEIGHTS = { 'N': 45, 'R': 30, 'SR': 15, 'SSR': 7, 'L': 3 };

function App() {
  const [screen, setScreen] = useState('home'); 
  const [activeTab, setActiveTab] = useState("be_group");
  const [selectedLessonId, setSelectedLessonId] = useState(null);
  
  const [quizState, setQuizState] = useState({
    mode: 'choice',
    questions: [], currentIndex: 0, answers: [], currentQ: null, selectedChoice: null,
    arrangePicked: [], isCorrect: null, showExplain: false, shuffledChoices: [], combo: 0
  });

  const [gachaState, setGachaState] = useState({ mode: 'idle', resultCard: null, isNew: false });
  const [showGallery, setShowGallery] = useState(false);
  const [showHint, setShowHint] = useState(false);

  const [userData, setUserData] = useState({
    coins: 0, ownedCards: ["c_cat"], lessonStats: {}, totalCorrect: 0, dailyPoints: { date: "", points: 0 }
  });
  const fileInputRef = useRef(null);

  useEffect(() => {
      try {
          const saved = localStorage.getItem(LS_KEY);
          if (saved) {
              const parsed = JSON.parse(saved);
              if (parsed.lessonStats) {
                  Object.keys(parsed.lessonStats).forEach(lid => {
                      const l = parsed.lessonStats[lid];
                      if(l.choice && l.choice.stars > 3) l.choice.stars = 3;
                      if(l.arrange && l.arrange.stars > 3) l.arrange.stars = 3;
                  });
              }
              setUserData(prev => ({ ...prev, ...parsed }));
          }
      } catch {}
  }, []);

  useEffect(() => { try { localStorage.setItem(LS_KEY, JSON.stringify(userData)); } catch {} }, [userData]);

  useEffect(() => {
      const today = getTodayString();
      if (userData.dailyPoints.date !== today) setUserData(prev => ({ ...prev, dailyPoints: { date: today, points: 0 } }));
  }, [userData.dailyPoints.date]);

  const prepareLesson = (lid) => { setSelectedLessonId(lid); setScreen('modal_mode'); };

  const startLesson = (mode) => {
    const lesson = LESSONS.find(l => l.id === selectedLessonId);
    const newQuestions = [];
    for(let i=0; i<QUESTIONS_PER_SET; i++) newQuestions.push(lesson.generator());
    
    const firstQ = newQuestions[0];
    const choices = mode === 'choice' ? ensureFourChoices(firstQ.choices) : shuffle(firstQ.speak.replace(/[.?!]/g, '').split(' ')); 

    setQuizState({
        mode: mode, questions: newQuestions, currentIndex: 0, answers: Array(QUESTIONS_PER_SET).fill(null),
        currentQ: firstQ, selectedChoice: null, arrangePicked: [], isCorrect: null, showExplain: false,
        shuffledChoices: choices, combo: 0
    });
    setScreen('quiz');
    setShowHint(false);
  };

  const handleChoiceAnswer = (choice) => {
    if (quizState.showExplain) return;
    finalizeAnswer(choice === quizState.currentQ.correctAnswerText, choice);
  };

  const handleArrangePick = (word, indexInChoices) => {
      if (quizState.showExplain) return;
      const newPicked = [...quizState.arrangePicked, { word, idx: indexInChoices }];
      setQuizState(prev => ({ ...prev, arrangePicked: newPicked }));
      if (newPicked.length === quizState.shuffledChoices.length) {
          const sentence = newPicked.map(p => p.word).join(' ');
          const correctSentence = quizState.currentQ.speak.replace(/[.?!]/g, '');
          finalizeAnswer(sentence === correctSentence, null);
      }
  };
  
  const resetArrange = () => setQuizState(prev => ({ ...prev, arrangePicked: [] }));

  const finalizeAnswer = (isCorrect, choiceVal) => {
    speakEn(quizState.currentQ.speak);
    const newAnswers = [...quizState.answers];
    newAnswers[quizState.currentIndex] = isCorrect;
    setQuizState(prev => ({ ...prev, selectedChoice: choiceVal, isCorrect: isCorrect, showExplain: true, answers: newAnswers, combo: isCorrect ? prev.combo + 1 : 0 }));
  };

  const nextQuestion = () => {
    const nextIdx = quizState.currentIndex + 1;
    if (nextIdx >= QUESTIONS_PER_SET) {
        finishQuiz();
    } else {
        const nextQ = quizState.questions[nextIdx];
        const nextChoices = quizState.mode === 'choice' ? ensureFourChoices(nextQ.choices) : shuffle(nextQ.speak.replace(/[.?!]/g, '').split(' '));
        setQuizState(prev => ({
            ...prev, currentIndex: nextIdx, currentQ: nextQ, selectedChoice: null, arrangePicked: [],
            isCorrect: null, showExplain: false, shuffledChoices: nextChoices
        }));
        setShowHint(false);
    }
  };

  const finishQuiz = () => {
    const correctCount = quizState.answers.filter(a => a === true).length;
    let earnedCoins = correctCount * 5;
    if (correctCount === 10) earnedCoins += 50; else if (correctCount >= 8) earnedCoins += 20;

    const lid = selectedLessonId;
    const mode = quizState.mode;
    const currentLessonStats = userData.lessonStats[lid] || { choice: {stars:0}, arrange: {stars:0} };
    const modeStats = currentLessonStats[mode] || { stars:0, playCount:0, highScore:0 };

    if (modeStats.stars >= MAX_STARS) {
        earnedCoins = Math.floor(earnedCoins / 2);
    }

    let newStars = modeStats.stars;
    if (correctCount === 10 && newStars < MAX_STARS) newStars += 1;
    
    const newModeStats = { stars: newStars, playCount: (modeStats.playCount || 0) + 1, highScore: Math.max((modeStats.highScore || 0), correctCount * 10) };
    const today = getTodayString();
    const currentDaily = userData.dailyPoints.date === today ? userData.dailyPoints.points : 0;

    setUserData(prev => ({
        ...prev, coins: prev.coins + earnedCoins, totalCorrect: prev.totalCorrect + correctCount,
        lessonStats: { ...prev.lessonStats, [lid]: { ...currentLessonStats, [mode]: newModeStats } },
        dailyPoints: { date: today, points: currentDaily + earnedCoins }
    }));
    setScreen('result');
  };

  const startGacha = () => {
      if (userData.coins < GACHA_COST) return alert(`${GACHA_COST}ã‚³ã‚¤ãƒ³å¿…è¦ã§ã™ï¼`);
      setUserData(prev => ({ ...prev, coins: prev.coins - GACHA_COST }));
      setGachaState({ mode: 'chest', resultCard: null, isNew: false });
  };
  const openChest = () => {
      const availableRarities = Object.keys(RARITY_WEIGHTS);
      const weightedPool = [];
      availableRarities.forEach(r => { for(let i=0; i<RARITY_WEIGHTS[r]; i++) weightedPool.push(r); });
      const rarity = rand(weightedPool);
      const pool = CARDS.filter(c => c.rarity === rarity);
      const card = rand(pool) || CARDS[0];
      const isNew = !userData.ownedCards.includes(card.id);
      setGachaState(prev => ({ ...prev, mode: 'open' }));
      setTimeout(() => {
          setGachaState({ mode: 'result', resultCard: card, isNew: isNew });
          if(isNew) setUserData(prev => ({ ...prev, ownedCards: [...prev.ownedCards, card.id] }));
      }, 1000);
  };
  const closeGacha = () => setGachaState({ mode: 'idle', resultCard: null, isNew: false });

  // Save/Load
  const exportData = () => { const blob = new Blob([JSON.stringify(userData)],{type:"application/json"}); const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download=`english-save.json`; a.click(); };
  const importData = (e) => { const f=e.target.files[0]; if(!f)return; const r=new FileReader(); r.onload=(ev)=>{ try{setUserData(p=>({...p,...JSON.parse(ev.target.result)}));alert("OK!");}catch{alert("Error");} }; r.readAsText(f); };
  const resetData = () => { if(confirm("ãƒ‡ãƒ¼ã‚¿ã‚’æ¶ˆã—ã¾ã™ã‹ï¼Ÿ")) { localStorage.removeItem(LS_KEY); window.location.reload(); } };

  // --- Render Helpers ---
  const StarIcon = ({ filled }) => (
    <svg className={`w-9 h-9 md:w-10 md:h-10 star-icon ${filled ? 'text-yellow-400 star-active' : 'text-slate-200'}`} fill="currentColor" viewBox="0 0 20 20">
        <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />
    </svg>
  );

  const renderStarsRow = (count) => (
      <div className="flex gap-1 justify-center">
        {[...Array(MAX_STARS)].map((_, i) => <StarIcon key={i} filled={i < count} />)}
      </div>
  );

  // Helper to determine card style based on rarity
  const getCardStyle = (rarity) => {
      switch (rarity) {
          case 'L': return 'card-l';
          case 'SSR': return 'card-ssr';
          case 'SR': return 'bg-gradient-to-br from-yellow-100 to-amber-300 border-amber-400 shadow-md';
          case 'R': return 'bg-gradient-to-br from-slate-200 to-slate-400 border-slate-500 shadow-sm';
          default: return 'bg-white border-slate-200 shadow-sm';
      }
  };

  const getGroupHint = (hintId) => HINT_TABLES[hintId] || HINT_TABLES["default"];

  // 1. Home
  if (screen === 'home') {
      const currentCardsCount = userData.ownedCards.length;
      return (
        <div className="min-h-screen pb-24 font-medium">
            <header className="bg-white/90 backdrop-blur-sm p-3 shadow-sm sticky top-0 z-20 rounded-b-3xl border-b-4 border-indigo-100">
                <div className="max-w-xl mx-auto flex flex-nowrap justify-between items-center gap-2 overflow-x-auto scrollbar-hide">
                    <h1 className="text-lg md:text-xl font-extrabold text-indigo-600 flex items-center gap-1 shrink-0">
                        <span className="animate-bounce">ğŸ«</span> <T t="å°å­¦2å¹´ç”Ÿ"/> English
                    </h1>
                    <div className="flex items-center gap-2 text-xs md:text-sm shrink-0">
                        <div className="bg-sky-100 text-sky-800 px-2 py-1 rounded-lg font-bold border border-sky-200 flex items-center whitespace-nowrap"><span className="mr-1">ğŸ“…</span><T t="ä»Šæ—¥"/>: {userData.dailyPoints.points}</div>
                        <div className="bg-amber-100 text-amber-800 px-2 py-1 rounded-lg font-bold border border-amber-200 flex items-center shadow-sm whitespace-nowrap"><span className="mr-1">ğŸ’°</span><T t="åˆè¨ˆ"/>: {userData.coins}</div>
                        <div className="flex gap-1">
                            <button onClick={exportData} title="ã‚»ãƒ¼ãƒ–" className="px-3 py-1 bg-slate-100 hover:bg-slate-200 rounded-lg text-slate-600 border border-slate-300 font-bold whitespace-nowrap">ã‚»ãƒ¼ãƒ–</button>
                            <label title="ãƒ­ãƒ¼ãƒ‰" className="px-3 py-1 bg-slate-100 hover:bg-slate-200 rounded-lg text-slate-600 border border-slate-300 cursor-pointer font-bold whitespace-nowrap">ãƒ­ãƒ¼ãƒ‰<input type="file" ref={fileInputRef} onChange={importData} className="hidden" accept=".json"/></label>
                        </div>
                    </div>
                </div>
            </header>

            <main className="max-w-xl mx-auto p-4">
                <div className="flex gap-2 mb-6 overflow-x-auto pb-2 scrollbar-hide justify-center">
                    {LESSON_GROUPS.map(g => (
                        <button key={g.id} onClick={() => setActiveTab(g.id)} className={`px-4 py-2 rounded-full font-bold text-sm whitespace-nowrap transition-all flex items-center gap-1 ${activeTab===g.id ? g.bg+' '+g.text+' ring-2 ring-offset-2 ring-'+g.text.split('-')[1]+'-300 shadow-md scale-105' : 'bg-white text-slate-400 border border-slate-200'}`}>
                            <span>{g.icon}</span> {g.name}
                        </button>
                    ))}
                </div>

                <div className="grid grid-cols-1 gap-4 mb-8 animate-slide-up">
                    {LESSONS.filter(l => l.groupId === activeTab).map(l => {
                        const group = LESSON_GROUPS.find(g => g.id === l.groupId);
                        const lessonData = userData.lessonStats[l.id] || { choice: {stars:0}, arrange: {stars:0} };
                        const choiceStats = lessonData.choice || { stars:0, highScore:0, playCount:0 };
                        const arrangeStats = lessonData.arrange || { stars:0, highScore:0, playCount:0 };
                        
                        return (
                            <button key={l.id} onClick={() => prepareLesson(l.id)} className={`relative ${group.bg} rounded-2xl p-1 border-b-4 ${group.border} transition-all hover:-translate-y-1 active:scale-95 active:translate-y-0 group w-full min-h-[90px]`}>
                                <div className="bg-white/80 rounded-xl p-2 flex flex-row items-center gap-4 text-left w-full h-full">
                                    <div className="text-4xl pl-2 group-hover:scale-110 transition-transform">{l.icon}</div>
                                    <div className="flex-grow flex flex-col justify-center">
                                        <div className={`font-bold text-lg mb-2 ${group.text}`}><T t={l.name} /></div>
                                        <div className="grid grid-cols-2 gap-2">
                                            
                                            {/* Lv1 Stats */}
                                            <div className="bg-white rounded-lg p-1 shadow-sm border border-slate-100 flex items-center justify-between px-2">
                                                <div className="flex flex-col">
                                                    <div className="text-xs font-bold text-sky-700 flex items-center gap-1"><span className="bg-sky-100 px-1 rounded text-sky-600">Lv1</span> <T t="ç©´åŸ‹"/>ã‚</div>
                                                    <div className="mt-1 transform scale-75 origin-left">{renderStarsRow(choiceStats.stars)}</div>
                                                </div>
                                                <div className="text-right flex gap-3">
                                                    <div className="flex flex-col items-center"><span className="text-[8px] text-slate-400 leading-none"><T t="å›"/>æ•°</span><span className="text-sm font-black text-slate-600 leading-tight">{choiceStats.playCount}</span></div>
                                                    <div className="flex flex-col items-center"><span className="text-[8px] text-slate-400 leading-none"><T t="æœ€é«˜"/></span><span className="text-sm font-black text-slate-600 leading-tight">{choiceStats.highScore}</span></div>
                                                </div>
                                            </div>

                                            {/* Lv2 Stats */}
                                            <div className="bg-white rounded-lg p-1 shadow-sm border border-slate-100 flex items-center justify-between px-2">
                                                <div className="flex flex-col">
                                                    <div className="text-xs font-bold text-pink-700 flex items-center gap-1"><span className="bg-pink-100 px-1 rounded text-pink-600">Lv2</span> <T t="ä¸¦"/>ã¹<T t="æ›¿"/>ãˆ</div>
                                                    <div className="mt-1 transform scale-75 origin-left">{renderStarsRow(arrangeStats.stars)}</div>
                                                </div>
                                                <div className="text-right flex gap-3">
                                                    <div className="flex flex-col items-center"><span className="text-[8px] text-slate-400 leading-none"><T t="å›"/>æ•°</span><span className="text-sm font-black text-slate-600 leading-tight">{arrangeStats.playCount}</span></div>
                                                    <div className="flex flex-col items-center"><span className="text-[8px] text-slate-400 leading-none"><T t="æœ€é«˜"/></span><span className="text-sm font-black text-slate-600 leading-tight">{arrangeStats.highScore}</span></div>
                                                </div>
                                            </div>

                                        </div>
                                    </div>
                                </div>
                            </button>
                        );
                    })}
                </div>

                <div className="bg-gradient-to-br from-indigo-800 to-violet-900 rounded-3xl p-1 shadow-lg relative overflow-hidden mb-4 group cursor-pointer hover:shadow-xl transition-all" onClick={startGacha}>
                    <div className="bg-white/10 p-5 rounded-[20px] relative z-10 flex flex-col items-center text-center">
                        <h2 className="font-bold text-lg text-white flex items-center gap-2 mb-1"><span className="text-2xl animate-float">ğŸ’</span> ãƒ¬ã‚¢ã‚«ãƒ¼ãƒ‰ã‚¬ãƒãƒ£</h2>
                        <p className="text-indigo-200 text-xs mb-3">1å› {GACHA_COST}ã‚³ã‚¤ãƒ³</p>
                        <div className="relative w-full">
                            <div className="w-full bg-gradient-to-r from-yellow-300 to-amber-500 text-amber-900 font-extrabold py-3 rounded-xl shadow-lg border-b-4 border-amber-600 group-hover:scale-[1.02] transition-transform">ã‚¬ãƒãƒ£ã‚’å¼•ãï¼</div>
                            {userData.coins >= GACHA_COST && <span className="absolute -top-3 -right-2 bg-red-500 text-white text-xs font-bold px-2 py-1 rounded-full animate-bounce shadow-lg border border-white">å¼•ã‘ã‚‹ã‚ˆï¼</span>}
                        </div>
                    </div>
                </div>
                
                <div className="flex justify-center gap-4">
                    <button onClick={() => setShowGallery(true)} className="bg-indigo-600 text-white px-6 py-2 rounded-full font-bold shadow-lg text-sm hover:bg-indigo-700 transition-colors">ğŸ“– ã‚«ãƒ¼ãƒ‰ãšã‹ã‚“</button>
                    <button onClick={resetData} className="text-xs text-slate-400 underline hover:text-red-400">ãƒªã‚»ãƒƒãƒˆ</button>
                </div>
            </main>

            {/* Gallery Modal */}
            {showGallery && (
                <div className="fixed inset-0 bg-slate-900/90 z-50 p-4 overflow-y-auto">
                    <div className="max-w-2xl mx-auto bg-white rounded-3xl p-6 min-h-full animate-pop-in">
                        <div className="flex justify-between items-center mb-6">
                            <h2 className="text-2xl font-bold text-slate-800">ğŸ“– ã‚«ãƒ¼ãƒ‰ãšã‹ã‚“</h2>
                            <button onClick={() => setShowGallery(false)} className="bg-slate-200 hover:bg-slate-300 px-4 py-2 rounded-full font-bold text-sm">ã¨ã˜ã‚‹</button>
                        </div>
                        <div className="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 gap-3">
                            {CARDS.map(c => {
                                const has = userData.ownedCards.includes(c.id);
                                return (
                                    <div key={c.id} className={`aspect-[3/4] rounded-xl flex flex-col items-center justify-center border-2 shadow-sm ${has ? getCardStyle(c.rarity) : 'border-slate-100 bg-slate-50'}`}>
                                        <div className={`text-4xl mb-2 ${has ? 'opacity-100' : 'opacity-20 grayscale'}`}>{c.emoji}</div>
                                        <div className={`text-[10px] font-bold text-center leading-tight ${has && c.rarity==='L' ? 'text-white' : 'text-slate-700'}`}>{has ? c.name : '???'}</div>
                                        {has && <div className="text-[8px] bg-white/50 px-1.5 py-0.5 rounded mt-1 font-bold text-slate-500">{c.rarity}</div>}
                                    </div>
                                )
                            })}
                        </div>
                    </div>
                </div>
            )}

            {/* Gacha Modal */}
            {gachaState.mode !== 'idle' && (
                <div className="fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4 backdrop-blur-sm">
                    {gachaState.mode === 'chest' && (
                        <div className="text-center animate-pop-in">
                            <div className="text-white font-bold text-2xl mb-8 drop-shadow-md">ã‚¿ãƒƒãƒ—ã—ã¦ã‚ã‘ã‚‹ï¼</div>
                            <button onClick={openChest} className="text-[150px] animate-shake cursor-pointer drop-shadow-[0_0_50px_rgba(255,215,0,0.6)] hover:scale-110 transition-transform">ğŸ</button>
                        </div>
                    )}
                    {gachaState.mode === 'open' && <div className="text-9xl animate-ping text-white">âœ¨</div>}
                    {gachaState.mode === 'result' && (
                        <div className={`rounded-3xl p-8 w-full max-w-sm text-center animate-pop-in relative overflow-hidden border-4 ${getCardStyle(gachaState.resultCard.rarity)}`}>
                            {/* Sparkles Overlay for high rarity */}
                            {['L', 'SSR'].includes(gachaState.resultCard.rarity) && (
                                <div className="absolute inset-0 pointer-events-none opacity-50 bg-[url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyMCIgaGVpZ2h0PSIyMCI+CjxwYXRoIGQ9Ik0xMCAwIEwxMiA4IEwyMCAxMCBMMTIgMTIgTDEwIDIwIEw4IDEyIEwwIDEwIEw4IDggWiIgZmlsbD0id2hpdGUiLz4KPC9zdmc+')] bg-[length:20px_20px] animate-pulse"></div>
                            )}
                            
                            {gachaState.isNew && <div className="absolute top-4 right-4 bg-red-500 text-white text-xs font-bold px-2 py-1 rounded-full animate-bounce shadow-md z-10">NEW!</div>}
                            
                            <div className="inline-block px-3 py-1 rounded-full bg-white/80 text-sm font-bold text-slate-500 mb-4 shadow-sm">{gachaState.resultCard.rarity}</div>
                            <div className="text-[120px] mb-6 leading-none animate-float drop-shadow-lg">{gachaState.resultCard.emoji}</div>
                            <h2 className={`text-2xl font-bold mb-8 ${gachaState.resultCard.rarity === 'L' ? 'text-white' : 'text-slate-800'}`}>{gachaState.resultCard.name}</h2>
                            <button onClick={closeGacha} className="bg-indigo-600 text-white font-bold py-3 px-8 rounded-xl w-full shadow-lg hover:bg-indigo-700 z-10 relative">ã¨ã˜ã‚‹</button>
                        </div>
                    )}
                </div>
            )}
        </div>
      );
  }

  // 2. Mode Select
  if (screen === 'modal_mode') {
      return (
          <div className="fixed inset-0 bg-indigo-900/80 backdrop-blur-sm z-50 flex items-center justify-center p-4">
              <div className="bg-white rounded-[40px] p-8 w-full max-w-sm animate-pop-in shadow-2xl relative">
                  <button onClick={() => setScreen('home')} className="absolute top-4 right-4 w-8 h-8 rounded-full bg-slate-100 text-slate-400 font-bold flex items-center justify-center hover:bg-slate-200">Ã—</button>
                  <h2 className="text-2xl font-bold text-center mb-6 text-indigo-800"><T t="é›£æ˜“åº¦ã‚’é¸ã‚“ã§ã­"/></h2>
                  <div className="grid gap-4">
                      <button onClick={() => startLesson('choice')} className="group bg-sky-50 hover:bg-sky-100 border-b-4 border-sky-200 hover:border-sky-300 p-4 rounded-3xl text-left flex items-center gap-4 transition-all active:scale-95">
                          <div className="w-16 h-16 rounded-2xl bg-white flex items-center justify-center text-4xl shadow-sm group-hover:scale-110 transition-transform">ğŸ“</div>
                          <div><div className="font-bold text-sky-800 text-lg">Lv1 <T t="ç©´åŸ‹"/>ã‚</div><div className="text-xs text-sky-600 font-bold"><T t="é¸"/>ã‚“ã§<T t="ç­”"/>ãˆã‚‹</div></div>
                      </button>
                      <button onClick={() => startLesson('arrange')} className="group bg-pink-50 hover:bg-pink-100 border-b-4 border-pink-200 hover:border-pink-300 p-4 rounded-3xl text-left flex items-center gap-4 transition-all active:scale-95">
                          <div className="w-16 h-16 rounded-2xl bg-white flex items-center justify-center text-4xl shadow-sm group-hover:scale-110 transition-transform">ğŸ§©</div>
                          <div><div className="font-bold text-pink-800 text-lg">Lv2 <T t="ä¸¦"/>ã¹<T t="æ›¿"/>ãˆ</div><div className="text-xs text-pink-600 font-bold"><T t="å˜èª"/>ã‚’<T t="ä¸¦"/>ã¹ã‚‹</div></div>
                      </button>
                  </div>
              </div>
          </div>
      );
  }

  // 3. Quiz
  if (screen === 'quiz' && quizState.currentQ) {
      const { currentQ, currentIndex, shuffledChoices, isCorrect, showExplain, combo, answers, arrangePicked } = quizState;
      const lesson = LESSONS.find(l => l.id === selectedLessonId);
      const hint = getGroupHint(lesson.hintId);

      return (
        <div className="min-h-screen bg-slate-100 flex flex-col items-center p-4 relative overflow-hidden">
            {combo > 1 && <div className="absolute top-32 right-4 text-amber-500 font-black italic text-5xl animate-pop-in z-50 pointer-events-none combo-text rotate-12 drop-shadow-xl">{combo} COMBO!</div>}
            
            {/* Header / Progress */}
            <div className="w-full max-w-2xl mt-2 mb-4 relative z-10">
                <div className="flex justify-between items-center mb-2">
                    <div className="flex gap-2">
                        <span className="text-xs font-bold text-slate-500 bg-white/80 px-2 py-1 rounded-lg">Q {currentIndex + 1} / {QUESTIONS_PER_SET}</span>
                        <button onClick={()=>setShowHint(true)} className="text-xs font-bold bg-yellow-100 text-yellow-700 px-2 py-1 rounded-lg border border-yellow-200 shadow-sm hover:bg-yellow-200 transition-colors">ğŸ’¡ ãƒ’ãƒ³ãƒˆ</button>
                    </div>
                    <button onClick={() => setScreen('home')} className="text-slate-400 text-sm font-bold bg-white/80 px-3 py-1 rounded-full shadow-sm hover:text-red-400">ã‚„ã‚ã‚‹</button>
                </div>
                <div className="flex justify-between gap-1.5 p-2 bg-white/60 rounded-full backdrop-blur-sm">
                    {answers.map((ans, i) => <div key={i} className={`h-3 w-full rounded-full transition-all duration-300 ${i===currentIndex?'bg-indigo-500 scale-125 shadow-lg ring-2 ring-indigo-200':ans===true?'bg-green-400':ans===false?'bg-red-400':'bg-slate-200'}`}></div>)}
                </div>
            </div>

            {/* Question Card */}
            <div className="w-full max-w-2xl bg-white rounded-[32px] shadow-xl overflow-hidden flex-grow flex flex-col relative animate-slide-up z-10 border-4 border-white">
                <div className="bg-indigo-50 p-6 text-center border-b border-indigo-100 flex-grow flex flex-col justify-center items-center min-h-[200px] relative overflow-hidden">
                    <div className="absolute top-[-20px] left-[-20px] w-24 h-24 bg-indigo-100 rounded-full opacity-50"></div>
                    <div className="absolute bottom-[-10px] right-[-10px] w-32 h-32 bg-indigo-100 rounded-full opacity-50"></div>
                    <h2 className="text-2xl md:text-3xl font-bold text-slate-800 mb-8 leading-relaxed relative z-10">
                        {quizState.mode === 'choice' ? currentQ.en.split('___').map((part, i, arr) => (
                                <React.Fragment key={i}>{part}{i < arr.length - 1 && <span className={`inline-block border-b-4 mx-2 px-3 min-w-[80px] text-center rounded-lg transition-colors ${showExplain ? (isCorrect ? 'border-green-400 bg-green-100 text-green-700' : 'border-red-400 bg-red-100 text-red-600') : 'border-slate-300 bg-white text-transparent'}`}>{showExplain ? currentQ.correctAnswerText : '?'}</span>}</React.Fragment>
                            )) : (
                            <div className="flex flex-wrap justify-center gap-2">
                                {arrangePicked.length > 0 ? arrangePicked.map((p, i) => <span key={i} className="px-4 py-2 bg-white rounded-xl shadow-sm border-b-4 border-indigo-200 font-bold text-indigo-700 text-xl animate-pop-in">{p.word}</span>) : <span className="text-slate-400 text-lg border-2 border-dashed border-slate-300 rounded-xl px-6 py-4"><T t="å˜èª"/>ã‚’<T t="é¸"/>ã‚“ã§<T t="æ–‡"/>ã‚’<T t="ä½œ"/>ã‚ã†</span>}
                            </div>
                        )}
                    </h2>
                    <div className="text-lg font-bold text-slate-600 bg-white/80 backdrop-blur-md px-6 py-2 rounded-2xl shadow-sm relative z-10"><T t={currentQ.jp} /></div>
                </div>
                <div className="p-4 bg-white/50">
                    {quizState.mode === 'choice' ? (
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                            {shuffledChoices.map((choice, idx) => (
                                <button key={idx} onClick={() => handleChoiceAnswer(choice)} disabled={showExplain} className={`py-5 rounded-2xl text-xl font-bold border-b-4 transition-all shadow-sm active:scale-95 active:border-b-0 active:translate-y-1 ${showExplain ? (choice===currentQ.correctAnswerText?'bg-green-100 border-green-400 text-green-800':choice===quizState.selectedChoice?'bg-red-100 border-red-400 text-red-800 opacity-60':'bg-slate-50 border-slate-200 text-slate-300') : 'bg-white border-slate-200 hover:border-indigo-300 hover:bg-indigo-50 text-slate-700'}`}>{choice}</button>
                            ))}
                        </div>
                    ) : (
                        <div>
                             <div className="flex flex-wrap gap-3 justify-center mb-6">
                                {shuffledChoices.map((word, idx) => {
                                    const isPicked = arrangePicked.some(p => p.idx === idx);
                                    return <button key={idx} onClick={() => handleArrangePick(word, idx)} disabled={isPicked || showExplain} className={`px-5 py-3 rounded-2xl text-xl font-bold border-b-4 transition-all active:scale-95 active:border-b-0 active:translate-y-1 ${isPicked ? 'opacity-0 scale-50' : 'bg-white border-slate-200 hover:bg-indigo-50 hover:border-indigo-300 text-slate-700 shadow-sm'}`}>{word}</button>;
                                })}
                            </div>
                            <div className="text-center"><button onClick={resetArrange} disabled={showExplain} className="text-sm text-red-400 font-bold bg-white px-4 py-2 rounded-full shadow-sm hover:bg-red-50">ãƒªã‚»ãƒƒãƒˆ</button></div>
                        </div>
                    )}
                </div>
                {showExplain && (
                    <div className="absolute inset-x-0 bottom-0 bg-white/95 backdrop-blur-md border-t border-slate-100 p-6 animate-slide-up shadow-[0_-10px_40px_rgba(0,0,0,0.1)] flex flex-col md:flex-row items-center justify-between gap-6 z-20 rounded-t-[32px]">
                        <div className="flex items-center gap-4">
                            <div className={`text-5xl ${isCorrect ? 'animate-pop-in' : 'animate-shake'}`}>{isCorrect ? 'â­•' : 'âŒ'}</div>
                            <div>
                                <div className={`font-black text-2xl mb-1 ${isCorrect ? 'text-green-500' : 'text-red-500'}`}>{isCorrect ? 'Good Job!' : 'Don\'t mind!'}</div>
                                <div className="text-slate-600 text-sm font-bold"><T t={currentQ.explainJP}/></div>
                            </div>
                        </div>
                        <button onClick={nextQuestion} className="w-full md:w-auto px-10 py-4 bg-indigo-500 text-white font-bold text-lg rounded-2xl shadow-lg hover:scale-105 hover:bg-indigo-600 transition-all">{currentIndex === QUESTIONS_PER_SET - 1 ? 'ã‘ã£ã‹ã¸' : 'ã¤ãã¸ â†’'}</button>
                    </div>
                )}
            </div>

            {/* Hint Modal */}
            {showHint && (
                <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4" onClick={() => setShowHint(false)}>
                    <div className="bg-white rounded-3xl p-6 w-full max-w-sm animate-pop-in shadow-2xl" onClick={e => e.stopPropagation()}>
                        <h3 className="font-bold text-xl mb-4 text-center border-b pb-2">ğŸ’¡ {hint.title}</h3>
                        {hint.content}
                        <button onClick={() => setShowHint(false)} className="mt-6 w-full py-3 bg-slate-100 hover:bg-slate-200 text-slate-600 rounded-xl font-bold transition-colors">ã¨ã˜ã‚‹</button>
                    </div>
                </div>
            )}
        </div>
      );
  }

  // 4. Result
  if (screen === 'result') {
      const correctCount = quizState.answers.filter(a => a === true).length;
      const isPerfect = correctCount === 10;
      const lid = selectedLessonId;
      const mode = quizState.mode;
      const stats = userData.lessonStats[lid][mode];
      const isMaster = stats.stars >= MAX_STARS;

      return (
          <div className="min-h-screen bg-indigo-500 flex items-center justify-center p-4 relative overflow-hidden">
             {isPerfect && <><div className="confetti" style={{left:'20%',backgroundColor:'#ffd700',animationDuration:'2s'}}></div><div className="confetti" style={{left:'50%',backgroundColor:'#ff69b4',animationDuration:'2.5s'}}></div><div className="confetti" style={{left:'80%',backgroundColor:'#00bfff',animationDuration:'2.2s'}}></div></>}
             <div className="bg-white rounded-[40px] p-8 w-full max-w-sm text-center shadow-2xl animate-pop-in border-8 border-white/20 bg-clip-padding">
                <div className="text-sm font-bold text-slate-400 mb-2 tracking-widest">RESULT</div>
                <h2 className={`text-4xl font-black mb-6 ${isPerfect ? 'text-yellow-500 drop-shadow-sm' : 'text-slate-700'}`}>{isPerfect ? 'PERFECT!!' : 'FINISH!'}</h2>
                <div className="text-8xl mb-2 animate-bounce-gentle">{isPerfect ? 'ğŸ‘‘' : (correctCount >= 8 ? 'ğŸ¥ˆ' : 'ğŸ¥‰')}</div>
                <div className="text-3xl font-black text-slate-800 mb-8">{correctCount} / 10 <span className="text-sm font-bold text-slate-400 ml-1"><T t="æ­£è§£"/></span></div>
                {isPerfect && (<div className="mb-6 bg-yellow-50 border-2 border-yellow-200 p-3 rounded-2xl animate-pulse"><span className="text-yellow-600 font-bold text-sm block mb-1">âœ¨ Star GET! âœ¨</span>{renderStarsRow(MAX_STARS)}</div>)}
                
                <div className="bg-slate-100 rounded-2xl p-4 mb-6">
                    <div className="flex justify-between items-center mb-1">
                        <span className="font-bold text-slate-600"><T t="ç²å¾—"/>ã‚³ã‚¤ãƒ³</span>
                        <span className="font-black text-2xl text-amber-500">+{correctCount * 5 + (isPerfect?50:correctCount>=8?20:0)}</span>
                    </div>
                    {isMaster && <div className="text-xs text-red-400 font-bold text-right">â€»ãƒã‚¹ã‚¿ãƒ¼æ¸ˆã¿ã®ãŸã‚åŠåˆ†</div>}
                </div>

                <div className="grid gap-3">
                    <button onClick={() => setScreen('home')} className="w-full py-4 rounded-2xl bg-indigo-600 text-white font-bold shadow-lg hover:bg-indigo-700 transition-transform active:scale-95">ãƒ›ãƒ¼ãƒ ã¸ã‚‚ã©ã‚‹</button>
                    <button onClick={() => setScreen('modal_mode')} className="w-full py-4 rounded-2xl bg-white border-2 border-indigo-100 text-indigo-600 font-bold hover:bg-indigo-50 transition-colors">ã‚‚ã†ã„ã¡ã©</button>
                </div>
             </div>
          </div>
      );
  }
  return null;
}

const root = ReactDOM.createRoot(document.getElementById('root'));
root.render(<App />);
    </script>
</body>
</html>